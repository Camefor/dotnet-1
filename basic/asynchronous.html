<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>异步编程 | .Net 实战笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="https://i.loli.net/2020/02/25/AOjBhkIxtb8dRgl.png">
    <meta name="description" content="熟知.NET Core核心组件设计原理;基于DDD开发云原生微服务应用;掌握.NET Core工程设计最佳实践;提升K8s微服务部署与维护技能">
    
    <link rel="preload" href="/dotnet/assets/css/0.styles.7248ee20.css" as="style"><link rel="preload" href="/dotnet/assets/js/app.4e9b76c2.js" as="script"><link rel="preload" href="/dotnet/assets/js/2.86915a18.js" as="script"><link rel="preload" href="/dotnet/assets/js/15.4d39118d.js" as="script"><link rel="prefetch" href="/dotnet/assets/js/10.7f9feb78.js"><link rel="prefetch" href="/dotnet/assets/js/11.43be2bc7.js"><link rel="prefetch" href="/dotnet/assets/js/12.e8c0fca4.js"><link rel="prefetch" href="/dotnet/assets/js/13.08e3036f.js"><link rel="prefetch" href="/dotnet/assets/js/14.6424aec3.js"><link rel="prefetch" href="/dotnet/assets/js/16.e2287734.js"><link rel="prefetch" href="/dotnet/assets/js/17.82266a75.js"><link rel="prefetch" href="/dotnet/assets/js/18.e3676b0a.js"><link rel="prefetch" href="/dotnet/assets/js/19.d7bd221d.js"><link rel="prefetch" href="/dotnet/assets/js/20.b8cf0f4e.js"><link rel="prefetch" href="/dotnet/assets/js/21.c5bcd1a9.js"><link rel="prefetch" href="/dotnet/assets/js/22.6fc7c7b2.js"><link rel="prefetch" href="/dotnet/assets/js/23.6c8b869e.js"><link rel="prefetch" href="/dotnet/assets/js/24.a831f9ed.js"><link rel="prefetch" href="/dotnet/assets/js/25.62b16105.js"><link rel="prefetch" href="/dotnet/assets/js/26.d88ba3e3.js"><link rel="prefetch" href="/dotnet/assets/js/27.f420e029.js"><link rel="prefetch" href="/dotnet/assets/js/28.fb34a308.js"><link rel="prefetch" href="/dotnet/assets/js/29.2490c8c9.js"><link rel="prefetch" href="/dotnet/assets/js/3.20bab2d8.js"><link rel="prefetch" href="/dotnet/assets/js/30.7b53e293.js"><link rel="prefetch" href="/dotnet/assets/js/31.97da4974.js"><link rel="prefetch" href="/dotnet/assets/js/32.6d3ad1a3.js"><link rel="prefetch" href="/dotnet/assets/js/33.3da29db6.js"><link rel="prefetch" href="/dotnet/assets/js/34.089e1fb3.js"><link rel="prefetch" href="/dotnet/assets/js/35.5f60b6ee.js"><link rel="prefetch" href="/dotnet/assets/js/36.cc872073.js"><link rel="prefetch" href="/dotnet/assets/js/37.e1ebcf4e.js"><link rel="prefetch" href="/dotnet/assets/js/38.bab59cca.js"><link rel="prefetch" href="/dotnet/assets/js/39.a39d6eae.js"><link rel="prefetch" href="/dotnet/assets/js/4.1363a917.js"><link rel="prefetch" href="/dotnet/assets/js/40.fae7fbb6.js"><link rel="prefetch" href="/dotnet/assets/js/41.5c5ffdf9.js"><link rel="prefetch" href="/dotnet/assets/js/42.0968c3b8.js"><link rel="prefetch" href="/dotnet/assets/js/43.e0cdc7be.js"><link rel="prefetch" href="/dotnet/assets/js/44.597b492a.js"><link rel="prefetch" href="/dotnet/assets/js/45.5e800e70.js"><link rel="prefetch" href="/dotnet/assets/js/46.527ac987.js"><link rel="prefetch" href="/dotnet/assets/js/47.6e336667.js"><link rel="prefetch" href="/dotnet/assets/js/48.5cf812b1.js"><link rel="prefetch" href="/dotnet/assets/js/49.f3403fdb.js"><link rel="prefetch" href="/dotnet/assets/js/5.e6eb57b9.js"><link rel="prefetch" href="/dotnet/assets/js/50.53f4771b.js"><link rel="prefetch" href="/dotnet/assets/js/51.a4151538.js"><link rel="prefetch" href="/dotnet/assets/js/52.0e39eecc.js"><link rel="prefetch" href="/dotnet/assets/js/53.7fefff6f.js"><link rel="prefetch" href="/dotnet/assets/js/54.e11d2956.js"><link rel="prefetch" href="/dotnet/assets/js/55.77862968.js"><link rel="prefetch" href="/dotnet/assets/js/56.031c2977.js"><link rel="prefetch" href="/dotnet/assets/js/57.e1f250f4.js"><link rel="prefetch" href="/dotnet/assets/js/58.f84112be.js"><link rel="prefetch" href="/dotnet/assets/js/59.771eb349.js"><link rel="prefetch" href="/dotnet/assets/js/6.a9924f8b.js"><link rel="prefetch" href="/dotnet/assets/js/7.da95d574.js"><link rel="prefetch" href="/dotnet/assets/js/8.c208d4c3.js"><link rel="prefetch" href="/dotnet/assets/js/9.4de8d1ac.js">
    <link rel="stylesheet" href="/dotnet/assets/css/0.styles.7248ee20.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/dotnet/" class="home-link router-link-active"><!----> <span class="site-name">.Net 实战笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/dotnet/basic/introduction.html" class="nav-link">
  Get Start
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow down"></span></button> <button type="button" aria-label="Books" class="mobile-dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/python" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Python
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/linux" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Linux
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/architecture" target="_blank" rel="noopener noreferrer" class="nav-link external">
  系统架构设计
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://ccstudio.com.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/colin-chang/dotnet" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/dotnet/basic/introduction.html" class="nav-link">
  Get Start
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow down"></span></button> <button type="button" aria-label="Books" class="mobile-dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/python" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Python
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/linux" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Linux
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/architecture" target="_blank" rel="noopener noreferrer" class="nav-link external">
  系统架构设计
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://ccstudio.com.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/colin-chang/dotnet" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>.Net基础</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dotnet/basic/introduction.html" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#_1-net-core-简介" class="sidebar-link">1.Net Core 简介</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#_2-net-core-特点" class="sidebar-link">2.Net Core 特点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#免费开源" class="sidebar-link">免费开源</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#跨平台" class="sidebar-link">跨平台</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#高性能" class="sidebar-link">高性能</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#共享友好" class="sidebar-link">共享友好</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#_3-net-core应用场景" class="sidebar-link">3.Net Core应用场景</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#web应用" class="sidebar-link">Web应用</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#桌面应用" class="sidebar-link">桌面应用</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#微服务" class="sidebar-link">微服务</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#云应用程序" class="sidebar-link">云应用程序</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#物联网" class="sidebar-link">物联网</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#_4-net-core组件" class="sidebar-link">4.Net Core组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#coreclr" class="sidebar-link">CoreCLR</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#corefx" class="sidebar-link">CoreFx</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#cli" class="sidebar-link">CLI</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#roslyn" class="sidebar-link">Roslyn</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/basic/introduction.html#_5-本书简介" class="sidebar-link">5. 本书简介</a></li></ul></li><li><a href="/dotnet/basic/thread.html" class="sidebar-link">多线程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_1-进程" class="sidebar-link">1. 进程</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_2-线程" class="sidebar-link">2. 线程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_2-1-原生线程" class="sidebar-link">2.1 原生线程</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_2-2-托管线程" class="sidebar-link">2.2 托管线程</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_2-3-多线程基础" class="sidebar-link">2.3 多线程基础</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_2-4-线程本地存储" class="sidebar-link">2.4 线程本地存储</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_3-应用程序域" class="sidebar-link">3. 应用程序域</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_4-线程同步" class="sidebar-link">4. 线程同步</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_4-1-join" class="sidebar-link">4.1 Join</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_4-2-interlocked" class="sidebar-link">4.2 Interlocked</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_4-3-线程安全集合" class="sidebar-link">4.3 线程安全集合</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_4-4-methodimplattribute" class="sidebar-link">4.4 MethodImplAttribute</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_4-5-自旋锁" class="sidebar-link">4.5 自旋锁</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_4-6-互斥锁" class="sidebar-link">4.6 互斥锁</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_4-7-混合锁" class="sidebar-link">4.7 混合锁</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_4-8-读写锁" class="sidebar-link">4.8 读写锁</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_4-9-信号量" class="sidebar-link">4.9 信号量</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_4-10-waithandle" class="sidebar-link">4.10 WaitHandle</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_4-11-多线程版单例模式" class="sidebar-link">4.11 多线程版单例模式</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_4-12-生产者消费者模式" class="sidebar-link">4.12 生产者消费者模式</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_5-线程池" class="sidebar-link">5. 线程池</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_5-1-线程池简介" class="sidebar-link">5.1 线程池简介</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_5-2-线程池特点" class="sidebar-link">5.2. 线程池特点</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_6-ui资源跨线程调用" class="sidebar-link">6. UI资源跨线程调用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_6-1-wpf" class="sidebar-link">6.1 WPF</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/thread.html#_6-2-winform" class="sidebar-link">6.2 WinForm</a></li></ul></li></ul></li><li><a href="/dotnet/basic/asynchronous.html" aria-current="page" class="active sidebar-link">异步编程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/basic/asynchronous.html#_1-eap" class="sidebar-link">1. EAP</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/asynchronous.html#_2-apm" class="sidebar-link">2. APM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/basic/asynchronous.html#_2-1-简单使用" class="sidebar-link">2.1 简单使用</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/asynchronous.html#_2-2-同步调用" class="sidebar-link">2.2 同步调用</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/asynchronous.html#_2-3-委托异步调用" class="sidebar-link">2.3 委托异步调用</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/basic/asynchronous.html#_3-tpl" class="sidebar-link">3. TPL</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/basic/asynchronous.html#_3-1-简单使用" class="sidebar-link">3.1 简单使用</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/asynchronous.html#_3-2-valuetask" class="sidebar-link">3.2 ValueTask</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/asynchronous.html#_3-3-同步调用" class="sidebar-link">3.3 同步调用</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/asynchronous.html#_3-4-并行异步" class="sidebar-link">3.4 并行异步</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/asynchronous.html#_3-5-自定义异步方法" class="sidebar-link">3.5 自定义异步方法</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/asynchronous.html#_4-异步本地存储" class="sidebar-link">4. 异步本地存储</a></li><li class="sidebar-sub-header"><a href="/dotnet/basic/asynchronous.html#_5-异常处理" class="sidebar-link">5. 异常处理</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>依赖注入</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>文件系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>配置选项</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>日志框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>承载系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>管道</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>静态文件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>路由</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>异常处理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>缓存</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>会话</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>认证授权</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>IdentityServer</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据访问</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>WebAPI</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>跨域资源共享</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>本地化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>健康检查</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其它主题</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="异步编程"><a href="#异步编程" class="header-anchor">#</a> 异步编程</h1> <p>.Net 中很多的类接口设计的时候都考虑了多线程问题,简化了多线程程序的开发。不用自己去写<code>WaitHandler</code>等这些底层的代码。随着历史的发展,这些类的接口设计演化经历过三种不同的风格:<code>EAP</code>、<code>APM</code>和<code>TPL</code>。</p> <h2 id="_1-eap"><a href="#_1-eap" class="header-anchor">#</a> 1. EAP</h2> <p><code>EAP</code>是<code>Event-based Asynchronous Pattern</code>(基于事件的异步模型)的简写。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">// 注：WebClient类在.Net Core中不被支持，推荐使用HttpClient替代</span>
<span class="token class-name"><span class="token keyword">var</span></span> wc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
wc<span class="token punctuation">.</span>DownloadStringCompleted <span class="token operator">+=</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

wc<span class="token punctuation">.</span><span class="token function">DownloadStringAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">&quot;https://www.baidu.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>EAP</code>特点是一个异步方法配一个<code>***Completed</code>事件。使用简单，但业务复杂的时比较麻烦,比如下载 A 成功后再下载 B,如果下载 B 成功再下载 C,否则就下载 D,会出现类似JS的多层回调函数嵌套的问题。</p> <h2 id="_2-apm"><a href="#_2-apm" class="header-anchor">#</a> 2. APM</h2> <p><code>APM</code>是<code>Asynchronous Programming Model</code>(异步编程模型)的缩写。是.Net 旧版本中广泛使用的异步编程模型。</p> <p><code>APM</code>方法名字以 <code>BeginXXX</code> 开头,调用结束后需要 <code>EndXXX</code>回收资源。</p> <p>.Net 中有如下的常用类支持<code>APM</code>:<code>Stream</code>、<code>SqlCommand</code>、<code>Socket</code> 等。</p> <h3 id="_2-1-简单使用"><a href="#_2-1-简单使用" class="header-anchor">#</a> 2.1 简单使用</h3> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">//异步非阻塞方式</span>
<span class="token class-name"><span class="token keyword">var</span></span> fs <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">OpenRead</span><span class="token punctuation">(</span><span class="token string">&quot;/Users/zhangcheng/test.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">BeginRead</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> ar <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">EndRead</span><span class="token punctuation">(</span>ar<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> fs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_2-2-同步调用"><a href="#_2-2-同步调用" class="header-anchor">#</a> 2.2 同步调用</h3> <p><code>APM</code>方法名字以 <code>BeginXXX</code> 开头,返回类型为<code>IAsyncResult</code>的对象，该对象有一个<code>AsyncWaitHandle</code>属性是用来等待异步任务执行结束的一个同步信号。如果等待<code>AsyncWaitHandle</code>则，异步会阻塞并转为同步执行。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">// 同步阻塞方式</span>
<span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> fs <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">OpenRead</span><span class="token punctuation">(</span><span class="token string">&quot;/Users/zhangcheng/test.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token number">10</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> aResult <span class="token operator">=</span>
        fs<span class="token punctuation">.</span><span class="token function">BeginRead</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    aResult<span class="token punctuation">.</span>AsyncWaitHandle<span class="token punctuation">.</span><span class="token function">WaitOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//同步等待任务执行结束</span>
    fs<span class="token punctuation">.</span><span class="token function">EndRead</span><span class="token punctuation">(</span>aResult<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_2-3-委托异步调用"><a href="#_2-3-委托异步调用" class="header-anchor">#</a> 2.3 委托异步调用</h3> <p>旧版.NET中,委托类型具有<code>Invoke</code>和<code>BeginInvoke</code>两个方法分别用于同步和异步调用委托。其中<code>BeginInvoke</code>使用的就是APL风格。</p> <p><strong>通过<code>BeginInvoke</code>异步调用委托在.NET Core中不被支持。</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> addDel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Func<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//模拟耗时操作</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//委托同步调用</span>
<span class="token class-name"><span class="token keyword">var</span></span> res <span class="token operator">=</span> addDel<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
res <span class="token operator">=</span> <span class="token function">addDel</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//简化写法</span>


<span class="token comment">//委托异步调用</span>
addDel<span class="token punctuation">.</span><span class="token function">BeginInvoke</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> ar <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> addDel<span class="token punctuation">.</span><span class="token function">EndInvoke</span><span class="token punctuation">(</span>ar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> addDel<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="_3-tpl"><a href="#_3-tpl" class="header-anchor">#</a> 3. TPL</h2> <h3 id="_3-1-简单使用"><a href="#_3-1-简单使用" class="header-anchor">#</a> 3.1 简单使用</h3> <p><code>TPL</code>是<code>Task Parallel Library</code>(并行任务库存)是.Net 4.0 之后带来的新特性,更简洁,更方便。现在.Net 平台下已经广泛使用。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> fs <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">OpenRead</span><span class="token punctuation">(</span><span class="token string">&quot;/Users/zhangcheng/test.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">ReadAsync</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li><strong><code>TPL</code>风格运行我们用线性方式编写异步程序。</strong> .NET中目前大多数耗时操作都提供了TPL风格的方法。</li> <li><strong><code>TPL</code>风格编程可以大幅提升系统吞吐量</strong>，B/S程序效果更为显著，可以使用异步编程的地方尽量不要使用同步。</li> <li><code>await</code>会确保异步结果返回后再执行后续代码，不会阻塞主线程。</li> <li><code>TPL</code>风格方法都习惯以 <code>Async</code>结尾。</li> <li>使用<code>await</code>关键字方法必须使用<code>async</code>修饰</li> <li>接口中声明方法时不能使用<code>async</code>关键字，在其实现类中可以。</li></ul> <h6 id="tpl风格方法允许以下三种类型的返回值"><a href="#tpl风格方法允许以下三种类型的返回值" class="header-anchor">#</a> <code>TPL</code>风格方法允许以下三种类型的返回值：</h6> <ul><li><code>Task/ValueTask</code>。异步Task做返回类型，相当于无返回值。方法被调用时支持<code>await</code>等待。</li> <li><code>Task&lt;T&gt;/ValueTask&lt;T&gt;</code>。  <code>T</code>为异步方法内部实际返回类型。</li> <li><code>void</code>。使用<code>void</code>做返回类型的异步方法，被调用时不支持<code>await</code>等待。</li></ul> <h3 id="_3-2-valuetask"><a href="#_3-2-valuetask" class="header-anchor">#</a> 3.2 ValueTask</h3> <p>C# 7.0提供了<code>ValueTask/ValueTask&lt;T&gt;</code>两种可用于异步编程的值类型，其用法与<code>Task/Task&lt;T&gt;</code>相似。</p> <p>由于<code>Task/Task&lt;T&gt;</code>是一个引用类型，从异步方法返回一个<code>Task</code>对象意味着每次调用该方法时都需要在托管堆中分配内存。如果异步方法结果立即可用或同步完成，此方式的内存开销代价就不值得了，而这也正是作为值类型的<code>ValueTask/ValueTask&lt;T&gt;</code>存在的意义。</p> <p>每个<code>ValueTask</code>只能被消费一次，其可以异步等待（<code>await</code>）操作完成，或者利用<code>AsTask</code>转换为<code>Task</code>。</p> <p><code>ValueTask</code>是具有两个字段的值类型，而<code>Task</code>是具有单个字段的引用类型。因此，使用<code>ValueTask</code>意味着要处理更多的数据，如果<code>await</code>一个返回<code>ValueTask</code>的方法，那么该异步方法的状态机也会更大，它必须容纳一个包含两个字段的结构体而不是在使用<code>Task</code>时的单个引用。</p> <p>此外，如果异步方法的使用者使用<code>Task.WhenAll</code>或者<code>Task.WhenAny</code>，在异步方法中使用<code>ValueTask&lt;T&gt;</code>作为返回类型可能会代价很高。这是因为您需要使用<code>AsTask</code>方法将<code>ValueTask&lt;T&gt;</code>转换为<code>Task&lt;T&gt;</code>，这会引发一个分配，而如果使用起初缓存的<code>Task&lt;T&gt;</code>，则可以轻松避免这种分配。</p> <p>经验法则是这样的，<strong>当异步方法结果立即可用或需要同步执行时，异步方法返回<code>ValueTask/ValueTask&lt;T&gt;</code>代替<code>Task/Task&lt;T&gt;</code>，可以避免不必要的内存开销</strong>。</p> <h3 id="_3-3-同步调用"><a href="#_3-3-同步调用" class="header-anchor">#</a> 3.3 同步调用</h3> <p>返回<code>Task</code>或<code>Task&lt;T&gt;``TPL</code>方法可以同步调用。调用<code>Task</code>对象的<code>Wait()</code>方法会同步阻塞线程直到任务执行完成，然后可以通过其<code>Result</code>属性拿到最终执行结果。</p> <p>在同步方法中不使用<code>await</code>而直接使用<code>Task</code>对象的<code>Result</code>属性也会导致等待阻塞。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> task <span class="token operator">=</span> <span class="token function">TestAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
task<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//同步等待</span>
Console<span class="token punctuation">.</span><span class="token function">Writeline</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//拿到执行结果</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>使用APL风格编程，一定要全程使用异步，中间任何环节使用同步，不仅不会提升程序性能，而且容易造成死锁。</strong></p> <h3 id="_3-4-并行异步"><a href="#_3-4-并行异步" class="header-anchor">#</a> 3.4 并行异步</h3> <p>如果存在多个相互无关联的异步任务，使用<code>await</code>语法会让多个任务顺序执行，如果想实现并发执行，我们可以使用<code>Task.WhenAll()</code>方式。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">GetWeatherAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> hc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//三个顺序执行</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token keyword">await</span> hc<span class="token punctuation">.</span><span class="token function">GetStringAsync</span><span class="token punctuation">(</span><span class="token string">&quot;https://baidu.com/getweather&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token keyword">await</span> hc<span class="token punctuation">.</span><span class="token function">GetStringAsync</span><span class="token punctuation">(</span><span class="token string">&quot;https://google.com/getweather&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token keyword">await</span> hc<span class="token punctuation">.</span><span class="token function">GetStringAsync</span><span class="token punctuation">(</span><span class="token string">&quot;https://bing.com/getweather&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>使用<code>Task.WhenAll()</code>改造后如下：<span id="whenall"></span></p> <div class="language-csharp line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-csharp"><code><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">GetWeatherAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> hc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> task1 <span class="token operator">=</span> hc<span class="token punctuation">.</span><span class="token function">GetStringAsync</span><span class="token punctuation">(</span><span class="token string">&quot;https://baidu.com/getweather&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> task2 <span class="token operator">=</span> hc<span class="token punctuation">.</span><span class="token function">GetStringAsync</span><span class="token punctuation">(</span><span class="token string">&quot;https://google.com/getweather&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> task3 <span class="token operator">=</span> hc<span class="token punctuation">.</span><span class="token function">GetStringAsync</span><span class="token punctuation">(</span><span class="token string">&quot;https://bing.com/getweather&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 三个任务并行执行</span>
        <span class="token class-name"><span class="token keyword">var</span></span> results <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">WhenAll</span><span class="token punctuation">(</span>task1<span class="token punctuation">,</span> task2<span class="token punctuation">,</span> task3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> result <span class="token keyword">in</span> results<span class="token punctuation">)</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_3-5-自定义异步方法"><a href="#_3-5-自定义异步方法" class="header-anchor">#</a> 3.5 自定义异步方法</h3> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token return-type class-name">Task</span> <span class="token function">DoAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// do something </span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> <span class="token function">DoAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//do something</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DateTime<span class="token punctuation">&gt;</span></span> <span class="token function">GetDateAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 从简单对象Task 可以使用 Task.FromResult()</span>
    <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>Today<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span>DateTime<span class="token punctuation">&gt;</span></span> <span class="token function">GetTimeAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 返回值立即可用时建议使用值类型ValueTask&lt;T&gt;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ValueTask<span class="token punctuation">&lt;</span>DateTime<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="_4-异步本地存储"><a href="#_4-异步本地存储" class="header-anchor">#</a> 4. 异步本地存储</h3> <p>异步是基于线程池的，它可以高效地使用有限的线程完成大量并行任务。异步方法存在一个负责状态检查并执行回调的线程和若干任务处理线程，其线程调度由系统完成，执行异步任务和回调的线程可能不同，因此线程本地存储并不适用于异步场景，而异步本地存储因此而生。</p> <div class="language-csharp line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-csharp"><code><span class="token comment">//异步共享变量</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name"><span class="token keyword">string</span></span> _name <span class="token operator">=</span> <span class="token string">&quot;Colin&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//异步本地变量    各异步任务中独享变量复本</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">AsyncLocal<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> _age <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AsyncLocal<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>Value <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        _name <span class="token operator">=</span> <span class="token string">&quot;Robin&quot;</span><span class="token punctuation">;</span>
        _age<span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token number">19</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">_name</span><span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">_age<span class="token punctuation">.</span>Value</span><span class="token punctuation">}</span></span><span class="token string"> years old&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        _name <span class="token operator">=</span> <span class="token string">&quot;Sean&quot;</span><span class="token punctuation">;</span>
        _age<span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">_name</span><span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">_age<span class="token punctuation">.</span>Value</span><span class="token punctuation">}</span></span><span class="token string"> years old&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">_name</span><span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">_age<span class="token punctuation">.</span>Value</span><span class="token punctuation">}</span></span><span class="token string"> years old&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>异步本地存储保存在异步任务执行上下文中，切换不同异步任务时会自动切换对应任务的执行上下文，任务切换回来后会恢复之前保存的执行上下文。</p> <p>子任务可以读取父任务上下文中的本地存储，但是子任务修改后不会影响父任务。类似于JavaScript中的变量名提升。但如果本地存储是一个引用类型，在子任务中修改了父任务的本地存储对象的某个属性是可以影响到父任务的。</p> <p>为了避免异步上下文中本地存储在不同任务间的相互影响，可以使用<code>ExecutionContext.SuppressFlow()</code>方法来禁止捕捉执行上下文。</p> <h3 id="_5-异常处理"><a href="#_5-异常处理" class="header-anchor">#</a> 5. 异常处理</h3> <p><strong>TPL风格编程中,有些情况下程序出现异常而不会抛出，也不会导致程序异常退出，此时会导致一些莫名的错误</strong>。但是显式的使用<code>try...catch</code>可以捕获到这些异常，这就要求开发者在代码编写过程中谨慎权衡，在可能出现的异常的地方进行手动异常处理。</p> <p>TPL编程有时会抛出<code>AggregateException</code>,这通常发生在并行有多个任务执行的情况下,如上面<a href="#whenall">并行异步</a>案例的情况。多个并行任务可能有多个异常, 因此<code>AggregateException</code>是一个聚合型异常类型，通过其<code>InnerExceptions</code> 属性可以获得多个异常对象信息，逐个解析即可。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/20/2021, 9:05:14 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/dotnet/basic/thread.html" class="prev">
        多线程
      </a></span> <span class="next"><a href="/dotnet/di/ioc.html">
        控制反转（IoC）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/dotnet/assets/js/app.4e9b76c2.js" defer></script><script src="/dotnet/assets/js/2.86915a18.js" defer></script><script src="/dotnet/assets/js/15.4d39118d.js" defer></script>
  </body>
</html>
