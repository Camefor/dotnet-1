<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>.Net Core 服务注册 | .Net 实战笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="https://i.loli.net/2020/02/25/AOjBhkIxtb8dRgl.png">
    <meta name="description" content="熟知.NET Core核心组件设计原理;基于DDD开发云原生微服务应用;掌握.NET Core工程设计最佳实践;提升K8s微服务部署与维护技能">
    
    <link rel="preload" href="/dotnet/assets/css/0.styles.7248ee20.css" as="style"><link rel="preload" href="/dotnet/assets/js/app.4e9b76c2.js" as="script"><link rel="preload" href="/dotnet/assets/js/2.86915a18.js" as="script"><link rel="preload" href="/dotnet/assets/js/30.7b53e293.js" as="script"><link rel="prefetch" href="/dotnet/assets/js/10.7f9feb78.js"><link rel="prefetch" href="/dotnet/assets/js/11.43be2bc7.js"><link rel="prefetch" href="/dotnet/assets/js/12.e8c0fca4.js"><link rel="prefetch" href="/dotnet/assets/js/13.08e3036f.js"><link rel="prefetch" href="/dotnet/assets/js/14.6424aec3.js"><link rel="prefetch" href="/dotnet/assets/js/15.4d39118d.js"><link rel="prefetch" href="/dotnet/assets/js/16.e2287734.js"><link rel="prefetch" href="/dotnet/assets/js/17.82266a75.js"><link rel="prefetch" href="/dotnet/assets/js/18.e3676b0a.js"><link rel="prefetch" href="/dotnet/assets/js/19.d7bd221d.js"><link rel="prefetch" href="/dotnet/assets/js/20.b8cf0f4e.js"><link rel="prefetch" href="/dotnet/assets/js/21.c5bcd1a9.js"><link rel="prefetch" href="/dotnet/assets/js/22.6fc7c7b2.js"><link rel="prefetch" href="/dotnet/assets/js/23.6c8b869e.js"><link rel="prefetch" href="/dotnet/assets/js/24.a831f9ed.js"><link rel="prefetch" href="/dotnet/assets/js/25.62b16105.js"><link rel="prefetch" href="/dotnet/assets/js/26.d88ba3e3.js"><link rel="prefetch" href="/dotnet/assets/js/27.f420e029.js"><link rel="prefetch" href="/dotnet/assets/js/28.fb34a308.js"><link rel="prefetch" href="/dotnet/assets/js/29.2490c8c9.js"><link rel="prefetch" href="/dotnet/assets/js/3.20bab2d8.js"><link rel="prefetch" href="/dotnet/assets/js/31.97da4974.js"><link rel="prefetch" href="/dotnet/assets/js/32.6d3ad1a3.js"><link rel="prefetch" href="/dotnet/assets/js/33.3da29db6.js"><link rel="prefetch" href="/dotnet/assets/js/34.089e1fb3.js"><link rel="prefetch" href="/dotnet/assets/js/35.5f60b6ee.js"><link rel="prefetch" href="/dotnet/assets/js/36.cc872073.js"><link rel="prefetch" href="/dotnet/assets/js/37.e1ebcf4e.js"><link rel="prefetch" href="/dotnet/assets/js/38.bab59cca.js"><link rel="prefetch" href="/dotnet/assets/js/39.a39d6eae.js"><link rel="prefetch" href="/dotnet/assets/js/4.1363a917.js"><link rel="prefetch" href="/dotnet/assets/js/40.fae7fbb6.js"><link rel="prefetch" href="/dotnet/assets/js/41.5c5ffdf9.js"><link rel="prefetch" href="/dotnet/assets/js/42.0968c3b8.js"><link rel="prefetch" href="/dotnet/assets/js/43.e0cdc7be.js"><link rel="prefetch" href="/dotnet/assets/js/44.597b492a.js"><link rel="prefetch" href="/dotnet/assets/js/45.5e800e70.js"><link rel="prefetch" href="/dotnet/assets/js/46.527ac987.js"><link rel="prefetch" href="/dotnet/assets/js/47.6e336667.js"><link rel="prefetch" href="/dotnet/assets/js/48.5cf812b1.js"><link rel="prefetch" href="/dotnet/assets/js/49.f3403fdb.js"><link rel="prefetch" href="/dotnet/assets/js/5.e6eb57b9.js"><link rel="prefetch" href="/dotnet/assets/js/50.53f4771b.js"><link rel="prefetch" href="/dotnet/assets/js/51.a4151538.js"><link rel="prefetch" href="/dotnet/assets/js/52.0e39eecc.js"><link rel="prefetch" href="/dotnet/assets/js/53.7fefff6f.js"><link rel="prefetch" href="/dotnet/assets/js/54.e11d2956.js"><link rel="prefetch" href="/dotnet/assets/js/55.77862968.js"><link rel="prefetch" href="/dotnet/assets/js/56.031c2977.js"><link rel="prefetch" href="/dotnet/assets/js/57.e1f250f4.js"><link rel="prefetch" href="/dotnet/assets/js/58.f84112be.js"><link rel="prefetch" href="/dotnet/assets/js/59.771eb349.js"><link rel="prefetch" href="/dotnet/assets/js/6.a9924f8b.js"><link rel="prefetch" href="/dotnet/assets/js/7.da95d574.js"><link rel="prefetch" href="/dotnet/assets/js/8.c208d4c3.js"><link rel="prefetch" href="/dotnet/assets/js/9.4de8d1ac.js">
    <link rel="stylesheet" href="/dotnet/assets/css/0.styles.7248ee20.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/dotnet/" class="home-link router-link-active"><!----> <span class="site-name">.Net 实战笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/dotnet/basic/introduction.html" class="nav-link">
  Get Start
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow down"></span></button> <button type="button" aria-label="Books" class="mobile-dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/python" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Python
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/linux" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Linux
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/architecture" target="_blank" rel="noopener noreferrer" class="nav-link external">
  系统架构设计
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://ccstudio.com.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/colin-chang/dotnet" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/dotnet/basic/introduction.html" class="nav-link">
  Get Start
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow down"></span></button> <button type="button" aria-label="Books" class="mobile-dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/python" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Python
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/linux" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Linux
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/architecture" target="_blank" rel="noopener noreferrer" class="nav-link external">
  系统架构设计
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://ccstudio.com.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/colin-chang/dotnet" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>.Net基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>依赖注入</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dotnet/di/ioc.html" class="sidebar-link">控制反转（IoC）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/ioc.html#_1-流程控制反转" class="sidebar-link">1. 流程控制反转</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/ioc.html#_2-好莱坞法则" class="sidebar-link">2. 好莱坞法则</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/ioc.html#_3-流程定制" class="sidebar-link">3. 流程定制</a></li></ul></li><li><a href="/dotnet/di/dm.html" class="sidebar-link">基于IoC的设计模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/dm.html#_1-模板方法-template-method" class="sidebar-link">1. 模板方法（Template Method）</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/dm.html#_2-工厂方法-factory-method" class="sidebar-link">2. 工厂方法（Factory Method）</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/dm.html#_3-抽象工厂-abstract-factory" class="sidebar-link">3. 抽象工厂（Abstract Factory）</a></li></ul></li><li><a href="/dotnet/di/di.html" class="sidebar-link">依赖注入（DI）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/di.html#_1-容器提供服务" class="sidebar-link">1. 容器提供服务</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/di.html#_2-依赖注入方式" class="sidebar-link">2. 依赖注入方式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/di.html#_2-1-构造器注入" class="sidebar-link">2.1 构造器注入</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/di.html#_2-2-属性注入" class="sidebar-link">2.2 属性注入</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/di.html#_2-3-方法注入" class="sidebar-link">2.3 方法注入</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/di/di.html#_3-service-locator" class="sidebar-link">3. Service Locator</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/di.html#_4-net-core中的di" class="sidebar-link">4. .Net Core中的DI</a></li></ul></li><li><a href="/dotnet/di/register.html" aria-current="page" class="active sidebar-link">.Net Core 服务注册</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/register.html#_1-servicedescriptor" class="sidebar-link">1. ServiceDescriptor</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/register.html#_2-iservicecollection" class="sidebar-link">2. IServiceCollection</a></li></ul></li><li><a href="/dotnet/di/consume.html" class="sidebar-link">.Net Core 服务消费</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/consume.html#_1-serviceprovider" class="sidebar-link">1. ServiceProvider</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/consume.html#_2-消费服务" class="sidebar-link">2. 消费服务</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/consume.html#_3-服务集合" class="sidebar-link">3. 服务集合</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/consume.html#_4-泛型支持" class="sidebar-link">4. 泛型支持</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/consume.html#_5-构造函数选择" class="sidebar-link">5. 构造函数选择</a></li></ul></li><li><a href="/dotnet/di/lifetime.html" class="sidebar-link">服务生命周期</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/lifetime.html#_1-服务范围" class="sidebar-link">1. 服务范围</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/lifetime.html#_2-生命周期管理模式" class="sidebar-link">2. 生命周期管理模式</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/lifetime.html#_3-服务对象回收" class="sidebar-link">3. 服务对象回收</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/lifetime.html#_4-asp-net-core-服务生命周期" class="sidebar-link">4. Asp.Net Core 服务生命周期</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/lifetime.html#_5-asp-net-core-服务范围检验" class="sidebar-link">5. ASP.NET Core 服务范围检验</a></li></ul></li><li><a href="/dotnet/di/aspnet.html" class="sidebar-link">Asp.Net Core 依赖注入使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/aspnet.html#_1-依赖注入在管道构建过程中的使用" class="sidebar-link">1. 依赖注入在管道构建过程中的使用</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/aspnet.html#_2-依赖服务注册" class="sidebar-link">2. 依赖服务注册</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/aspnet.html#_3-依赖服务消费" class="sidebar-link">3. 依赖服务消费</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/aspnet.html#_3-1-controller-pagemodel" class="sidebar-link">3.1 Controller/PageModel</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/aspnet.html#_3-2-view" class="sidebar-link">3.2 View</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/aspnet.html#_3-3-httpcontext获取实例" class="sidebar-link">3.3 HttpContext获取实例</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/di/aspnet.html#_4-autofac" class="sidebar-link">4. Autofac</a></li></ul></li><li><a href="/dotnet/di/src.html" class="sidebar-link">Asp.Net Core 依赖注入源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/src.html#_1-程序启动di源码解析" class="sidebar-link">1. 程序启动DI源码解析</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/src.html#_2-配置文件di" class="sidebar-link">2. 配置文件DI</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/src.html#_2-1-配置文件di基本使用" class="sidebar-link">2.1 配置文件DI基本使用</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/src.html#_2-2-配置文件di源码解析" class="sidebar-link">2.2 配置文件DI源码解析</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>文件系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>配置选项</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>日志框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>承载系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>管道</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>静态文件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>路由</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>异常处理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>缓存</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>会话</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>认证授权</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>IdentityServer</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据访问</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>WebAPI</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>跨域资源共享</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>本地化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>健康检查</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其它主题</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="net-core-服务注册"><a href="#net-core-服务注册" class="header-anchor">#</a> .Net Core 服务注册</h1> <p><strong>服务注册本质是创建相应的<code>ServiceDescriptor</code>对象并将其添加到指定<code>IServiceCollection</code>集合对象中的过程，期间并不会实例化服务对象。服务对象实例化是在从容器中获取服务实例(<code>ServiceProvider.GetService&lt;T&gt;</code>)时才会被创建。</strong></p> <h2 id="_1-servicedescriptor"><a href="#_1-servicedescriptor" class="header-anchor">#</a> 1. ServiceDescriptor</h2> <p><code>ServiceDescriptor</code>提供对服务的描述信息，这些信息将指导<code>ServiceProvider</code>正确地实施服务提供操作。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceDescriptor</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Type</span> ServiceType <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ServiceLifetime</span> Lifetime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Type</span> ImplementationType <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Func<span class="token punctuation">&lt;</span>IServiceProvider<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> ImplementationFactory <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> ImplementationInstance <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token function">ServiceDescriptor</span><span class="token punctuation">(</span><span class="token class-name">Type</span> serviceType<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token function">ServiceDescriptor</span><span class="token punctuation">(</span><span class="token class-name">Type</span> serviceType<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>IServiceProvider<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> factory<span class="token punctuation">,</span> <span class="token class-name">ServiceLifetime</span> lifetime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token function">ServiceDescriptor</span><span class="token punctuation">(</span><span class="token class-name">Type</span> serviceType<span class="token punctuation">,</span> <span class="token class-name">Type</span> implementationType<span class="token punctuation">,</span> <span class="token class-name">ServiceLifetime</span> lifetime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>ServiceType</code>属性代表提供服务的类型，由于标准化的服务一般会定义成接口，所以在绝大部分情况下体现为一个接口类型。</p> <p>类型为<code>ServiceLifetime</code>的属性<code>Lifetime</code>体现了<code>ServiceProvider</code>针对服务实例生命周期的控制方式。如下面的代码片段所示，<code>ServiceLifetime</code>是一个枚举类型，定义其中的三个选项（<code>Singleton</code>、<code>Scoped</code>和<code>Transient</code>）体现三种对服务对象生命周期的控制形式，我们在后续对此作专门的介绍。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ServiceLifetime</span>
<span class="token punctuation">{</span>
    Singleton<span class="token punctuation">,</span>
    Scoped<span class="token punctuation">,</span>
    Transient
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>ServiceDescriptor</code>的其它三个属性体现了服务实例的三种提供方式，并对应着三个构造函数。如果我们指定了服务的实现类型（对应于<code>ImplementationType</code>属性），那么最终的服务实例将通过调用定义在实现类型中某一个构造函数来创建。如果指定的是一个<code>Func&lt;IServiceProvider, object&gt;</code>对象（对应于<code>ImplementationFactory</code>属性），那么<code>IServiceProvider</code>对象将会将自身作为输入参数调用该委托对象来提供服务实例。如果我们直接指定一个现有的对象（对应的属性为<code>ImplementationInstance</code>），那么该对象就是最终提供的服务实例。</p> <p>如果我们采用直接提供服务实例的形式来创建<code>ServiceDescriptor</code>对象，意味着服务注册默认采用<code>Singleton</code>生命周期模式。对于通过其它两个构造函数创建的<code>ServiceDescriptor</code>对象来说，则需要显式指定采用的生命周期模式。</p> <p>除了调用上面介绍的三个构造函数来创建对应的<code>ServiceDescriptor</code>对象之外，我们还可以提供定义在<code>ServiceDescriptor</code>类型中一系列静态方法来创建该对象。如下面的代码片段所示，<code>ServiceDescriptor</code>提供了如下两个名为<code>Describe</code>的方法重载来创建对应的<code>ServiceDescriptor</code>对象。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceDescriptor</span>
<span class="token punctuation">{</span>   
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">ServiceDescriptor</span> <span class="token function">Describe</span><span class="token punctuation">(</span><span class="token class-name">Type</span> serviceType<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>IServiceProvider<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> implementationFactory<span class="token punctuation">,</span> <span class="token class-name">ServiceLifetime</span> lifetime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">ServiceDescriptor</span> <span class="token function">Describe</span><span class="token punctuation">(</span><span class="token class-name">Type</span> serviceType<span class="token punctuation">,</span> <span class="token class-name">Type</span> implementationType<span class="token punctuation">,</span> <span class="token class-name">ServiceLifetime</span> lifetime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>当我们调用上面两个<code>Describe</code>方法来创建<code>ServiceDescriptor</code>对象的时候总是需要指定采用的生命周期模式，为了让对象创建变得更加简单，<code>ServiceDescriptor</code>中还定义了一系列针对三种生命周期模式的静态工厂方法。如下所示的是针对<code>Singleton</code>模式的一组<code>Singleton</code>方法重载的定义，针对其它两种模式的<code>Scoped</code>和<code>Transient</code>方法具有类似的定义。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceDescriptor</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">ServiceDescriptor</span> <span class="token generic-method"><span class="token function">Singleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TService<span class="token punctuation">,</span> TImplementation<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TService</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span> <span class="token keyword">where</span> <span class="token class-name">TImplementation</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">TService</span></span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">ServiceDescriptor</span> <span class="token generic-method"><span class="token function">Singleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TService<span class="token punctuation">,</span> TImplementation<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Func<span class="token punctuation">&lt;</span>IServiceProvider<span class="token punctuation">,</span> TImplementation<span class="token punctuation">&gt;</span></span> implementationFactory<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TService</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span> <span class="token keyword">where</span> <span class="token class-name">TImplementation</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">TService</span></span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">ServiceDescriptor</span> <span class="token generic-method"><span class="token function">Singleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Func<span class="token punctuation">&lt;</span>IServiceProvider<span class="token punctuation">,</span> TService<span class="token punctuation">&gt;</span></span> implementationFactory<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TService</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">ServiceDescriptor</span> <span class="token generic-method"><span class="token function">Singleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">TService</span> implementationInstance<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TService</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">ServiceDescriptor</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token class-name">Type</span> serviceType<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>IServiceProvider<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> implementationFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">ServiceDescriptor</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token class-name">Type</span> serviceType<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> implementationInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">ServiceDescriptor</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token class-name">Type</span> service<span class="token punctuation">,</span> <span class="token class-name">Type</span> implementationType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="_2-iservicecollection"><a href="#_2-iservicecollection" class="header-anchor">#</a> 2. IServiceCollection</h2> <p><code>IServiceCollection</code>对象本质上就是一个元素类型为<code>ServiceDescriptor</code>的列表。在默认情况下我们使用的是实现该接口的<code>ServiceCollection</code>类型。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IServiceCollection</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IList<span class="token punctuation">&lt;</span>ServiceDescriptor<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceCollection</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IServiceCollection</span></span>
<span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_1-add"><a href="#_1-add" class="header-anchor">#</a> 1) Add</h4> <p>考虑到服务注册是一个高频调用的操作，所以<code>DI</code>框架为<code>IServiceCollection</code>接口定义了一系列扩展方法完成服务注册的工作，比如下面的这两个<code>Add</code>方法可以将指定的一个或者多个<code>ServiceDescriptor</code>对象添加到<code>IServiceCollection</code>集合中。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ServiceCollectionDescriptorExtensions</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> collection<span class="token punctuation">,</span> <span class="token class-name">ServiceDescriptor</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> collection<span class="token punctuation">,</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>ServiceDescriptor<span class="token punctuation">&gt;</span></span> descriptors<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_2-add-lifetime"><a href="#_2-add-lifetime" class="header-anchor">#</a> 2) Add{Lifetime}</h4> <p><code>DI</code>框架还针对具体生命周期模式为<code>IServiceCollection</code>接口定义了一系列的扩展方法，它们会根据提供的输入创建出对应的<code>ServiceDescriptor</code>对象并将其添加到指定的<code>IServiceCollection</code>对象中。如下所示的是针对<code>Singleton</code>模式的<code>AddSingleton</code>方法重载的定义，针对其它两个生命周期模式的<code>AddScoped</code>和<code>AddTransient</code>方法具有类似的定义。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ServiceCollectionServiceExtensions</span>
<span class="token punctuation">{</span>   
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TService</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TService<span class="token punctuation">,</span> TImplementation<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TService</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span> <span class="token keyword">where</span> <span class="token class-name">TImplementation</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">TService</span></span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name">TService</span> implementationInstance<span class="token punctuation">)</span>  <span class="token keyword">where</span> <span class="token class-name">TService</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TService<span class="token punctuation">,</span> TImplementation<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>IServiceProvider<span class="token punctuation">,</span> TImplementation<span class="token punctuation">&gt;</span></span> implementationFactory<span class="token punctuation">)</span>  <span class="token keyword">where</span> <span class="token class-name">TService</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span> <span class="token keyword">where</span> <span class="token class-name">TImplementation</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">TService</span></span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>IServiceProvider<span class="token punctuation">,</span> TService<span class="token punctuation">&gt;</span></span> implementationFactory<span class="token punctuation">)</span>  <span class="token keyword">where</span> <span class="token class-name">TService</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token function">AddSingleton</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name">Type</span> serviceType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token function">AddSingleton</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name">Type</span> serviceType<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>IServiceProvider<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> implementationFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token function">AddSingleton</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name">Type</span> serviceType<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> implementationInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token function">AddSingleton</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name">Type</span> serviceType<span class="token punctuation">,</span> <span class="token class-name">Type</span> implementationType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_3-tryadd"><a href="#_3-tryadd" class="header-anchor">#</a> 3) TryAdd</h4> <p>虽然针对同一个服务类型可以添加多个<code>ServiceDescriptor</code>，但这情况只有在应用需要使用到同一类型的多个服务实例的情况下才有意义，比如我们可以注册多个<code>ServiceDescriptor</code>来提供同一个主题的多个订阅者。如果我们总是根据指定的服务类型来提取单一的服务实例，这种情况下一个服务类型只需要一个<code>ServiceDescriptor</code>对象就够了。对于这种场景我们可能会使用如下两个名为<code>TryAdd</code>的扩展方法，该方法会根据指定<code>ServiceDescriptor</code>提供的服务类型判断对应的服务注册是否存在，只有<strong>不存在指定类型的服务注册情况下</strong>，我们提供的<code>ServiceDescriptor</code>才会被添加到指定的<code>IServiceCollection</code>对象中。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ServiceCollectionDescriptorExtensions</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TryAdd</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> collection<span class="token punctuation">,</span> <span class="token class-name">ServiceDescriptor</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TryAdd</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> collection<span class="token punctuation">,</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>ServiceDescriptor<span class="token punctuation">&gt;</span></span> descriptors<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_4-tryadd-lifetime"><a href="#_4-tryadd-lifetime" class="header-anchor">#</a> 4) TryAdd{Lifetime}</h4> <p>扩展方法<code>TryAdd</code>同样具有基于三种生命周期模式的版本，如下所示的针对<code>Singleton</code>模式的<code>TryAddSingleton</code>方法的定义。在指定服务类型对应的<code>ServiceDescriptor</code>不存在的情况下，它们会采用提供的实现类型、服务实例创建工厂以及服务实例来创建生命周期模式为<code>Singleton</code>的<code>ServiceDescriptor</code>对象并将其添加到指定的<code>IServiceCollection</code>对象中。针对其它两种生命周期模式的<code>TryAddScoped</code>和<code>TryAddTransient</code>方法具有类似的定义。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ServiceCollectionDescriptorExtensions</span>
<span class="token punctuation">{</span>    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">TryAddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> collection<span class="token punctuation">)</span>  <span class="token keyword">where</span> <span class="token class-name">TService</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">TryAddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TService<span class="token punctuation">,</span> TImplementation<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> collection<span class="token punctuation">)</span>  <span class="token keyword">where</span> <span class="token class-name">TService</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span>  <span class="token keyword">where</span> <span class="token class-name">TImplementation</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">TService</span></span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TryAddSingleton</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> collection<span class="token punctuation">,</span>  <span class="token class-name">Type</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">TryAddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> collection<span class="token punctuation">,</span>  <span class="token class-name">TService</span> instance<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TService</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">TryAddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span>  <span class="token class-name">Func<span class="token punctuation">&lt;</span>IServiceProvider<span class="token punctuation">,</span> TService<span class="token punctuation">&gt;</span></span> implementationFactory<span class="token punctuation">)</span>  <span class="token keyword">where</span> <span class="token class-name">TService</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">class</span></span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TryAddSingleton</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> collection<span class="token punctuation">,</span>  <span class="token class-name">Type</span> service<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>IServiceProvider<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">&gt;</span></span> implementationFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TryAddSingleton</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> collection<span class="token punctuation">,</span>  <span class="token class-name">Type</span> service<span class="token punctuation">,</span> <span class="token class-name">Type</span> implementationType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_5-tryaddenumerable"><a href="#_5-tryaddenumerable" class="header-anchor">#</a> 5) TryAddEnumerable</h4> <p>除了上面介绍的扩展方法<code>TryAdd</code>和<code>TryAdd{Lifetime}</code>之外，<code>IServiceCollection</code>接口还具有如下两个名为<code>TryAddEnumerable</code>的扩展方法。当<code>TryAddEnumerable</code>方法在决定将指定的<code>ServiceDescriptor</code>添加到<code>IServiceCollection</code>对象之前，它也会做存在性检验。与<code>TryAdd</code>和<code>TryAdd{Lifetime}</code>方法不同的是，该方法在<strong>判断执行的<code>ServiceDescriptor</code>是否存在时会同时考虑服务类型和实现类型。</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ServiceCollectionDescriptorExtensions</span>
<span class="token punctuation">{</span>   
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TryAddEnumerable</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name">ServiceDescriptor</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TryAddEnumerable</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>ServiceDescriptor<span class="token punctuation">&gt;</span></span> descriptors<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>TryAddEnumerable</code>判断存在性的实现类型不只是<code>ServiceDescriptor</code>的<code>ImplementationType</code>属性。如果<code>ServiceDescriptor</code>是通过一个指定的服务实例创建的，那么该实例的类型会作为用来判断存在与否的实现类型。如果<code>ServiceDescriptor</code>是服务实例工厂来创建的，那么代表服务实例创建工厂的<code>Func&lt;in T, out TResult&gt;</code>对象的第二个参数类型将被用于判断<code>ServiceDescriptor</code>的存在性。扩展方法<code>TryAddEnumerable</code>的实现逻辑可以通过如下这段程序来验证。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

services<span class="token punctuation">.</span><span class="token function">TryAddEnumerable</span><span class="token punctuation">(</span>ServiceDescriptor<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Singleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoobarbazgux<span class="token punctuation">,</span> Foo<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>services<span class="token punctuation">.</span>Count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token function">TryAddEnumerable</span><span class="token punctuation">(</span>ServiceDescriptor<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Singleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoobarbazgux<span class="token punctuation">,</span> Foo<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>services<span class="token punctuation">.</span>Count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token function">TryAddEnumerable</span><span class="token punctuation">(</span>ServiceDescriptor<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Singleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoobarbazgux<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>services<span class="token punctuation">.</span>Count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Func<span class="token punctuation">&lt;</span>IServiceProvider<span class="token punctuation">,</span> Foo<span class="token punctuation">&gt;</span></span> factory4Foo <span class="token operator">=</span> _ <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token function">TryAddEnumerable</span><span class="token punctuation">(</span>ServiceDescriptor<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Singleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoobarbazgux<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>factory4Foo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>services<span class="token punctuation">.</span>Count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

services<span class="token punctuation">.</span><span class="token function">TryAddEnumerable</span><span class="token punctuation">(</span>ServiceDescriptor<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Singleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoobarbazgux<span class="token punctuation">,</span> Bar<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>services<span class="token punctuation">.</span>Count <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token function">TryAddEnumerable</span><span class="token punctuation">(</span>ServiceDescriptor<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Singleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoobarbazgux<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>services<span class="token punctuation">.</span>Count <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Func<span class="token punctuation">&lt;</span>IServiceProvider<span class="token punctuation">,</span> Gux<span class="token punctuation">&gt;</span></span> factory4Gux <span class="token operator">=</span> _ <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Gux</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token function">TryAddEnumerable</span><span class="token punctuation">(</span>ServiceDescriptor<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Singleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoobarbazgux<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>factory4Gux<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>services<span class="token punctuation">.</span>Count <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>如果通过上述策略得到的实现类型为<code>Object</code>，那么<code>TryAddEnumerable</code>会因为实现类型不明确而抛出一个<code>ArgumentException</code>类型的异常。这种情况主要发生在提供的<code>ServiceDescriptor</code>对象是由服务实例工厂创建的情况，所以上面实例中用来创建<code>ServiceDescriptor</code>的工厂类型分别为<code>Func&lt;IServiceProvider, Foo&gt;</code>和<code>Func&lt;IServiceProvider, Gux&gt;</code>，而不是<code>Func&lt;IServiceProvider, object&gt;</code>。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> service <span class="token operator">=</span> ServiceDescriptor<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Singleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoobarbazgux<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>_ <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">TryAddEnumerable</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>假设我们采用如上所示的方式利用一个Lamda表达式来创建一个<code>ServiceDescriptor</code>对象，对于创建的<code>ServiceDescriptor</code>来说，其服务实例工厂是一个<code>Func&lt;IServiceProvider, object&gt;</code>对象，所以当我们将它作为参数调用<code>TryAddEnumerable</code>方法的会抛出如下图所示的<code>ArgumentException</code>异常。</p> <p><img src="https://i.loli.net/2020/02/26/GSMgkrhYCRnw5fT.png" alt="ArgumentException类型的异常"></p> <h4 id="_6-removeall-replace"><a href="#_6-removeall-replace" class="header-anchor">#</a> 6) RemoveAll &amp; Replace</h4> <p>上面介绍的这些方法最终的目的都是添加新的<code>ServiceDescriptor</code>到指定的<code>IServiceCollection</code>对象中，有的时候我们还希望删除或者替换现有的某个<code>ServiceDescriptor</code>，这种情况下通常发生在需要对当前使用框架中由某个服务提供的功能进行定制的时候。由于<code>IServiceCollection</code>实现了<code>IList&lt;ServiceDescriptor&gt;</code>接口，所以我们可以调用其<code>Clear</code>、<code>Remove</code>和<code>RemoveAt</code>方法来清除或者删除现有的<code>ServiceDescriptor</code>。除此之外，我们还可以选择如下这些扩展方法。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ServiceCollectionDescriptorExtensions</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token generic-method"><span class="token function">RemoveAll</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> collection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token function">RemoveAll</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> collection<span class="token punctuation">,</span>  <span class="token class-name">Type</span> serviceType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceCollection</span> <span class="token function">Replace</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> collection<span class="token punctuation">,</span>  <span class="token class-name">ServiceDescriptor</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>RemoveAll</code>和<code>RemoveAll&lt;T&gt;</code>方法帮助我们针对指定的服务类型来删除添加的<code>ServiceDescriptor</code>。<code>Replace</code>方法会使用指定的<code>ServiceDescriptor</code>去替换第一个具有相同服务类型（对应<code>ServiceType</code>属性）的<code>ServiceDescriptor</code>，实际操作是先删除后添加。如果从目前的<code>IServiceCollection</code>中找不到服务类型匹配的<code>ServiceDescriptor</code>，指定的<code>ServiceDescriptor</code>会直接添加到<code>IServiceCollection</code>对象中，这一逻辑也可以利用如下的程序来验证。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>ServiceDescriptor<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Singleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoobarbazgux<span class="token punctuation">,</span> Foo<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>services<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>it <span class="token operator">=&gt;</span> it<span class="token punctuation">.</span>ImplementationType <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Foo</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoobarbazgux<span class="token punctuation">,</span> Bar<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>ServiceDescriptor<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Singleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoobarbazgux<span class="token punctuation">,</span> Baz<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span><span class="token operator">!</span>services<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>it<span class="token operator">=&gt;</span>it<span class="token punctuation">.</span>ImplementationType <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Foo</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>services<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>it <span class="token operator">=&gt;</span> it<span class="token punctuation">.</span>ImplementationType <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Bar</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>services<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>it <span class="token operator">=&gt;</span> it<span class="token punctuation">.</span>ImplementationType <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Baz</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>参考文献
https://www.cnblogs.com/artech/p/net-core-di-07.html</p></blockquote></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/26/2021, 2:25:24 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/dotnet/di/di.html" class="prev">
        依赖注入（DI）
      </a></span> <span class="next"><a href="/dotnet/di/consume.html">
        .Net Core 服务消费
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/dotnet/assets/js/app.4e9b76c2.js" defer></script><script src="/dotnet/assets/js/2.86915a18.js" defer></script><script src="/dotnet/assets/js/30.7b53e293.js" defer></script>
  </body>
</html>
