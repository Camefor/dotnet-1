<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>服务生命周期 | .Net 实战笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="https://i.loli.net/2020/02/25/AOjBhkIxtb8dRgl.png">
    <meta name="description" content="熟知.NET Core核心组件设计原理;基于DDD开发云原生微服务应用;掌握.NET Core工程设计最佳实践;提升K8s微服务部署与维护技能">
    
    <link rel="preload" href="/dotnet/assets/css/0.styles.7248ee20.css" as="style"><link rel="preload" href="/dotnet/assets/js/app.4e9b76c2.js" as="script"><link rel="preload" href="/dotnet/assets/js/2.86915a18.js" as="script"><link rel="preload" href="/dotnet/assets/js/29.2490c8c9.js" as="script"><link rel="prefetch" href="/dotnet/assets/js/10.7f9feb78.js"><link rel="prefetch" href="/dotnet/assets/js/11.43be2bc7.js"><link rel="prefetch" href="/dotnet/assets/js/12.e8c0fca4.js"><link rel="prefetch" href="/dotnet/assets/js/13.08e3036f.js"><link rel="prefetch" href="/dotnet/assets/js/14.6424aec3.js"><link rel="prefetch" href="/dotnet/assets/js/15.4d39118d.js"><link rel="prefetch" href="/dotnet/assets/js/16.e2287734.js"><link rel="prefetch" href="/dotnet/assets/js/17.82266a75.js"><link rel="prefetch" href="/dotnet/assets/js/18.e3676b0a.js"><link rel="prefetch" href="/dotnet/assets/js/19.d7bd221d.js"><link rel="prefetch" href="/dotnet/assets/js/20.b8cf0f4e.js"><link rel="prefetch" href="/dotnet/assets/js/21.c5bcd1a9.js"><link rel="prefetch" href="/dotnet/assets/js/22.6fc7c7b2.js"><link rel="prefetch" href="/dotnet/assets/js/23.6c8b869e.js"><link rel="prefetch" href="/dotnet/assets/js/24.a831f9ed.js"><link rel="prefetch" href="/dotnet/assets/js/25.62b16105.js"><link rel="prefetch" href="/dotnet/assets/js/26.d88ba3e3.js"><link rel="prefetch" href="/dotnet/assets/js/27.f420e029.js"><link rel="prefetch" href="/dotnet/assets/js/28.fb34a308.js"><link rel="prefetch" href="/dotnet/assets/js/3.20bab2d8.js"><link rel="prefetch" href="/dotnet/assets/js/30.7b53e293.js"><link rel="prefetch" href="/dotnet/assets/js/31.97da4974.js"><link rel="prefetch" href="/dotnet/assets/js/32.6d3ad1a3.js"><link rel="prefetch" href="/dotnet/assets/js/33.3da29db6.js"><link rel="prefetch" href="/dotnet/assets/js/34.089e1fb3.js"><link rel="prefetch" href="/dotnet/assets/js/35.5f60b6ee.js"><link rel="prefetch" href="/dotnet/assets/js/36.cc872073.js"><link rel="prefetch" href="/dotnet/assets/js/37.e1ebcf4e.js"><link rel="prefetch" href="/dotnet/assets/js/38.bab59cca.js"><link rel="prefetch" href="/dotnet/assets/js/39.a39d6eae.js"><link rel="prefetch" href="/dotnet/assets/js/4.1363a917.js"><link rel="prefetch" href="/dotnet/assets/js/40.fae7fbb6.js"><link rel="prefetch" href="/dotnet/assets/js/41.5c5ffdf9.js"><link rel="prefetch" href="/dotnet/assets/js/42.0968c3b8.js"><link rel="prefetch" href="/dotnet/assets/js/43.e0cdc7be.js"><link rel="prefetch" href="/dotnet/assets/js/44.597b492a.js"><link rel="prefetch" href="/dotnet/assets/js/45.5e800e70.js"><link rel="prefetch" href="/dotnet/assets/js/46.527ac987.js"><link rel="prefetch" href="/dotnet/assets/js/47.6e336667.js"><link rel="prefetch" href="/dotnet/assets/js/48.5cf812b1.js"><link rel="prefetch" href="/dotnet/assets/js/49.f3403fdb.js"><link rel="prefetch" href="/dotnet/assets/js/5.e6eb57b9.js"><link rel="prefetch" href="/dotnet/assets/js/50.53f4771b.js"><link rel="prefetch" href="/dotnet/assets/js/51.a4151538.js"><link rel="prefetch" href="/dotnet/assets/js/52.0e39eecc.js"><link rel="prefetch" href="/dotnet/assets/js/53.7fefff6f.js"><link rel="prefetch" href="/dotnet/assets/js/54.e11d2956.js"><link rel="prefetch" href="/dotnet/assets/js/55.77862968.js"><link rel="prefetch" href="/dotnet/assets/js/56.031c2977.js"><link rel="prefetch" href="/dotnet/assets/js/57.e1f250f4.js"><link rel="prefetch" href="/dotnet/assets/js/58.f84112be.js"><link rel="prefetch" href="/dotnet/assets/js/59.771eb349.js"><link rel="prefetch" href="/dotnet/assets/js/6.a9924f8b.js"><link rel="prefetch" href="/dotnet/assets/js/7.da95d574.js"><link rel="prefetch" href="/dotnet/assets/js/8.c208d4c3.js"><link rel="prefetch" href="/dotnet/assets/js/9.4de8d1ac.js">
    <link rel="stylesheet" href="/dotnet/assets/css/0.styles.7248ee20.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/dotnet/" class="home-link router-link-active"><!----> <span class="site-name">.Net 实战笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/dotnet/basic/introduction.html" class="nav-link">
  Get Start
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow down"></span></button> <button type="button" aria-label="Books" class="mobile-dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/python" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Python
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/linux" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Linux
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/architecture" target="_blank" rel="noopener noreferrer" class="nav-link external">
  系统架构设计
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://ccstudio.com.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/colin-chang/dotnet" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/dotnet/basic/introduction.html" class="nav-link">
  Get Start
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow down"></span></button> <button type="button" aria-label="Books" class="mobile-dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/python" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Python
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/linux" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Linux
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/architecture" target="_blank" rel="noopener noreferrer" class="nav-link external">
  系统架构设计
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://ccstudio.com.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/colin-chang/dotnet" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>.Net基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>依赖注入</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dotnet/di/ioc.html" class="sidebar-link">控制反转（IoC）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/ioc.html#_1-流程控制反转" class="sidebar-link">1. 流程控制反转</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/ioc.html#_2-好莱坞法则" class="sidebar-link">2. 好莱坞法则</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/ioc.html#_3-流程定制" class="sidebar-link">3. 流程定制</a></li></ul></li><li><a href="/dotnet/di/dm.html" class="sidebar-link">基于IoC的设计模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/dm.html#_1-模板方法-template-method" class="sidebar-link">1. 模板方法（Template Method）</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/dm.html#_2-工厂方法-factory-method" class="sidebar-link">2. 工厂方法（Factory Method）</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/dm.html#_3-抽象工厂-abstract-factory" class="sidebar-link">3. 抽象工厂（Abstract Factory）</a></li></ul></li><li><a href="/dotnet/di/di.html" class="sidebar-link">依赖注入（DI）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/di.html#_1-容器提供服务" class="sidebar-link">1. 容器提供服务</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/di.html#_2-依赖注入方式" class="sidebar-link">2. 依赖注入方式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/di.html#_2-1-构造器注入" class="sidebar-link">2.1 构造器注入</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/di.html#_2-2-属性注入" class="sidebar-link">2.2 属性注入</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/di.html#_2-3-方法注入" class="sidebar-link">2.3 方法注入</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/di/di.html#_3-service-locator" class="sidebar-link">3. Service Locator</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/di.html#_4-net-core中的di" class="sidebar-link">4. .Net Core中的DI</a></li></ul></li><li><a href="/dotnet/di/register.html" class="sidebar-link">.Net Core 服务注册</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/register.html#_1-servicedescriptor" class="sidebar-link">1. ServiceDescriptor</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/register.html#_2-iservicecollection" class="sidebar-link">2. IServiceCollection</a></li></ul></li><li><a href="/dotnet/di/consume.html" class="sidebar-link">.Net Core 服务消费</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/consume.html#_1-serviceprovider" class="sidebar-link">1. ServiceProvider</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/consume.html#_2-消费服务" class="sidebar-link">2. 消费服务</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/consume.html#_3-服务集合" class="sidebar-link">3. 服务集合</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/consume.html#_4-泛型支持" class="sidebar-link">4. 泛型支持</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/consume.html#_5-构造函数选择" class="sidebar-link">5. 构造函数选择</a></li></ul></li><li><a href="/dotnet/di/lifetime.html" aria-current="page" class="active sidebar-link">服务生命周期</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/lifetime.html#_1-服务范围" class="sidebar-link">1. 服务范围</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/lifetime.html#_2-生命周期管理模式" class="sidebar-link">2. 生命周期管理模式</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/lifetime.html#_3-服务对象回收" class="sidebar-link">3. 服务对象回收</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/lifetime.html#_4-asp-net-core-服务生命周期" class="sidebar-link">4. Asp.Net Core 服务生命周期</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/lifetime.html#_5-asp-net-core-服务范围检验" class="sidebar-link">5. ASP.NET Core 服务范围检验</a></li></ul></li><li><a href="/dotnet/di/aspnet.html" class="sidebar-link">Asp.Net Core 依赖注入使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/aspnet.html#_1-依赖注入在管道构建过程中的使用" class="sidebar-link">1. 依赖注入在管道构建过程中的使用</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/aspnet.html#_2-依赖服务注册" class="sidebar-link">2. 依赖服务注册</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/aspnet.html#_3-依赖服务消费" class="sidebar-link">3. 依赖服务消费</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/aspnet.html#_3-1-controller-pagemodel" class="sidebar-link">3.1 Controller/PageModel</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/aspnet.html#_3-2-view" class="sidebar-link">3.2 View</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/aspnet.html#_3-3-httpcontext获取实例" class="sidebar-link">3.3 HttpContext获取实例</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/di/aspnet.html#_4-autofac" class="sidebar-link">4. Autofac</a></li></ul></li><li><a href="/dotnet/di/src.html" class="sidebar-link">Asp.Net Core 依赖注入源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/src.html#_1-程序启动di源码解析" class="sidebar-link">1. 程序启动DI源码解析</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/src.html#_2-配置文件di" class="sidebar-link">2. 配置文件DI</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/di/src.html#_2-1-配置文件di基本使用" class="sidebar-link">2.1 配置文件DI基本使用</a></li><li class="sidebar-sub-header"><a href="/dotnet/di/src.html#_2-2-配置文件di源码解析" class="sidebar-link">2.2 配置文件DI源码解析</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>文件系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>配置选项</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>日志框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>承载系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>管道</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>静态文件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>路由</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>异常处理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>缓存</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>会话</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>认证授权</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>IdentityServer</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据访问</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>WebAPI</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>跨域资源共享</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>本地化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>健康检查</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其它主题</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="服务生命周期"><a href="#服务生命周期" class="header-anchor">#</a> 服务生命周期</h1> <p>生命周期决定了<code>ServiceProvider</code>采用怎样的方式创建和回收服务实例。<code>ServiceProvider</code>具有三种基本的生命周期管理模式，分别对应着枚举类型<code>ServiceLifetime</code>的三个选项（<code>Singleton</code>、<code>Scoped</code>和<code>Transient</code>）。对于<code>ServiceProvider</code>支持的这三种生命周期管理模式，<code>Singleton</code>和<code>Transient</code>的语义很明确，前者（<code>Singleton</code>）表示以“单例”的方式管理服务实例的生命周期，意味着<code>ServiceProvider</code>对象多次针对同一个服务类型所提供的服务实例实际上是同一个对象；而后者（<code>Transient</code>）则完全相反，对于每次服务提供请求，<code>ServiceProvider</code>总会创建一个新的对象。那么<code>Scoped</code>又体现了<code>ServiceProvider</code>针对服务实例怎样的生命周期管理方式呢？</p> <h2 id="_1-服务范围"><a href="#_1-服务范围" class="header-anchor">#</a> 1. 服务范围</h2> <p><code>Scoped</code>代表一种怎样的生命周期模式，很多初学者往往搞不清楚。这里所谓的<code>Scope</code>指的是由<code>IServiceScope</code>接口表示的“服务范围”，该范围由<code>IServiceScopeFactory</code>接口表示的“服务范围工厂”来创建。如下面的代码片段所示，<code>IServiceProvider</code>的扩展方法<code>CreateScope</code>正是利用提供的<code>IServiceScopeFactory</code>服务实例来创建作为服务范围的<code>IServiceScope</code>对象。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IServiceScope</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">IServiceProvider</span> ServiceProvider <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IServiceScopeFactory</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">IServiceScope</span> <span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ServiceProviderServiceExtensions</span>
<span class="token punctuation">{</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IServiceScope</span> <span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceProvider</span> provider<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> provider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IServiceScopeFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><code>ServiceScope</code>为某个<code>ServiceProvider</code>对象圈定了一个“作用域”，枚举类型<code>ServiceLifetime</code>中的<code>Scoped</code>选项指的就是这么一个<code>ServiceScope</code>。若要充分理解<code>ServiceScope</code>和<code>ServiceProvider</code>之间的关系，我们需要简单了解一下<code>ServiceProvider</code>的层级结构。除了直接通过一个<code>ServiceCollection</code>对象创建一个独立的<code>ServiceProvider</code>对象之外，一个<code>ServiceProvider</code>还可以根据另一个<code>ServiceProvider</code>对象来创建，如果采用后一种创建方式，我们指定的<code>ServiceProvider</code>与创建的<code>ServiceProvider</code>将成为一种“父子”关系。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">ServiceProvider</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IServiceProvider</span><span class="token punctuation">,</span> <span class="token class-name">IDisposable</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ServiceProvider</span> _root<span class="token punctuation">;</span>
    <span class="token keyword">internal</span> <span class="token function">ServiceProvider</span><span class="token punctuation">(</span><span class="token class-name">ServiceProvider</span> parent<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _root <span class="token operator">=</span> parent<span class="token punctuation">.</span>_root<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//其它成员</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>虽然在创建过程中体现了<code>ServiceProvider</code>之间存在着一种树形化的层级结构，但是<code>ServiceProvider</code>对象本身并没有一个指向“父亲”的引用，它仅仅会保留针对根节点的引用。如上面的代码片段所示，针对根节点的引用体现为<code>ServiceProvider</code>类的字段<code>_root</code>。当我们根据作为“父亲”的<code>ServiceProvider</code>创建一个新的<code>ServiceProvider</code>的时候，父子均指向同一个“根”。我们可以将创建过程中体现的层级化关系称为“逻辑关系”，而将<code>ServiceProvider</code>对象自身的引用关系称为“物理关系”，下图清楚地揭示了这两种关系之间的转化。</p> <p><img src="https://i.loli.net/2020/02/26/Ab1HpIkl28tqWdB.png" alt="ServiceProvider层级关系"></p> <p>由于<code>ServiceProvider</code>自身是一个内部类型，我们不能采用调用构造函数的方式根据一个作为“父亲”的<code>ServiceProvider</code>创建另一个作为“儿子”的<code>ServiceProvider</code>，但是这个目的可以间接地通过创建<code>ServiceScope</code>的方式来完成。如下面的代码片段所示，我们首先创建一个独立的<code>ServiceProvider</code>并调用其<code>CreateScope</code>方法创建一个新的<code>ServiceScope</code>，它的<code>ServiceProvider</code>就是前者的“儿子”。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">IServiceProvider</span> serviceProvider1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IServiceProvider</span> serviceProvider2 <span class="token operator">=</span> serviceProvider1<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">;</span>
 
        <span class="token class-name"><span class="token keyword">object</span></span> root <span class="token operator">=</span> serviceProvider2<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetField</span><span class="token punctuation">(</span><span class="token string">&quot;_root&quot;</span><span class="token punctuation">,</span> BindingFlags<span class="token punctuation">.</span>Instance<span class="token operator">|</span> BindingFlags<span class="token punctuation">.</span>NonPublic<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>serviceProvider2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span><span class="token keyword">object</span><span class="token punctuation">.</span><span class="token function">ReferenceEquals</span><span class="token punctuation">(</span>serviceProvider1<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>如果读者朋友们希望进一步了解<code>ServiceScope</code>的创建以及它和<code>ServiceProvider</code>之间的关系，我们不妨先来看看作为<code>IServiceScope</code>接口默认实现的内部类型<code>ServiceScope</code>的定义。如下面的代码片段所示，<code>ServiceScope</code>仅仅是对一个<code>ServiceProvider</code>对象的简单封装而已。值得一提的是，当<code>ServiceScope</code>的<code>Dispose</code>方法被调用的时候，这个被封装的<code>ServiceProvider</code>的同名方法同时被执行。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">ServiceScope</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IServiceScope</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ServiceProvider</span> _scopedProvider<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token function">ServiceScope</span><span class="token punctuation">(</span><span class="token class-name">ServiceProvider</span> scopedProvider<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_scopedProvider <span class="token operator">=</span> scopedProvider<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _scopedProvider<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token return-type class-name">IServiceProvider</span> ServiceProvider
    <span class="token punctuation">{</span>
        <span class="token keyword">get</span> <span class="token punctuation">{</span><span class="token keyword">return</span> _scopedProvider<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><code>IServiceScopeFactory</code>接口的默认实现类型是一个名为<code>ServiceScopeFactory</code>的内部类型。如下面的代码片段所示，<code>ServiceScopeFactory</code>的只读字段<code>_provider</code>表示当前的<code>ServiceProvider</code>。当<code>CreateScope</code>方法被调用的时候，这个<code>ServiceProvider</code>的子<code>ServiceProvider</code>被创建出来，并被封装成返回的<code>ServiceScope</code>对象。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">ServiceScopeFactory</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IServiceScopeFactory</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ServiceProvider</span> _provider<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token function">ServiceScopeFactory</span><span class="token punctuation">(</span><span class="token class-name">ServiceProvider</span> provider<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _provider <span class="token operator">=</span> provider<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token return-type class-name">IServiceScope</span> <span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceScope</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceProvider</span><span class="token punctuation">(</span>_provider<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="_2-生命周期管理模式"><a href="#_2-生命周期管理模式" class="header-anchor">#</a> 2. 生命周期管理模式</h2> <p>只有在充分了解<code>ServiceScope</code>的创建过程以及它与<code>ServiceProvider</code>之间的关系之后，我们才会对<code>ServiceProvider</code>支持的三种生命周期管理模式（<code>Singleton</code>、<code>Scope</code>和<code>Transient</code>）具有深刻的认识。就服务实例的提供方式来说，它们之间具有如下的差异：</p> <ul><li><code>Singleton</code>：<code>IServiceProvider</code>创建的服务实例保存在作为根容器的<code>IServiceProvider</code>上，所有多个同根的<code>IServiceProvider</code>对象提供的针对同一类型的服务实例都是同一个对象。</li> <li><code>Scoped</code>：<code>IServiceProvider</code>创建的服务实例由自己保存，所以同一个<code>IServiceProvider</code>对象提供的针对同一类型的服务实例均是同一个对象。</li> <li><code>Transient</code>：针对每一次服务提供请求，<code>IServiceProvider</code>总是创建一个新的服务实例。</li></ul> <p>在一个控制台应用中定义了如下三个服务接口（<code>IFoo</code>、<code>IBar</code>和<code>IBaz</code>）以及分别实现它们的三个服务类(<code>Foo</code>、<code>Bar</code>和<code>Baz</code>)。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IFoo</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IBar</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IBaz</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IFoo</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IBar</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Baz</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IBaz</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>现在我们在作为程序入口的<code>Main</code>方法中创建一个<code>ServiceCollection</code>对象，并采用不同的生命周期管理模式完成针对三个服务接口的注册(<code>IFoo</code>/<code>Foo</code>、<code>IBar</code>/<code>Bar</code>和<code>IBaz</code>/<code>Baz</code>分别<code>Transient</code>、<code>Scoped</code>和<code>Singleton</code>)。我们接下来针对这个<code>ServiceCollection</code>对象创建一个<code>ServiceProvider</code>（<code>root</code>），并采用创建<code>ServiceScope</code>的方式创建它的两个子<code>ServiceProvider</code>（<code>child1</code>和<code>child2</code>）。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">IServiceProvider</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddTransient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoo<span class="token punctuation">,</span> Foo<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IBar<span class="token punctuation">,</span> Bar<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IBaz<span class="token punctuation">,</span> Baz<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IServiceProvider</span> child1 <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">;</span>
        <span class="token class-name">IServiceProvider</span> child2 <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">;</span>
 
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;ReferenceEquals(root.GetService&lt;IFoo&gt;(), root.GetService&lt;IFoo&gt;() = {0}&quot;</span><span class="token punctuation">,</span><span class="token function">ReferenceEquals</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoo<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoo<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;ReferenceEquals(child1.GetService&lt;IBar&gt;(), child1.GetService&lt;IBar&gt;() = {0}&quot;</span><span class="token punctuation">,</span><span class="token function">ReferenceEquals</span><span class="token punctuation">(</span>child1<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IBar<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> child1<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IBar<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;ReferenceEquals(child1.GetService&lt;IBar&gt;(), child2.GetService&lt;IBar&gt;() = {0}&quot;</span><span class="token punctuation">,</span><span class="token function">ReferenceEquals</span><span class="token punctuation">(</span>child1<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IBar<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> child2<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IBar<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;ReferenceEquals(child1.GetService&lt;IBaz&gt;(), child2.GetService&lt;IBaz&gt;() = {0}&quot;</span><span class="token punctuation">,</span><span class="token function">ReferenceEquals</span><span class="token punctuation">(</span>child1<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IBaz<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> child2<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IBaz<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>为了验证<code>ServiceProvider</code>针对<code>Transient</code>模式是否总是创建新的服务实例，我们利用同一个<code>ServiceProvider</code>（<code>root</code>）获取针对服务接口<code>IFoo</code>的实例并进行比较。为了验证<code>ServiceProvider</code>针对<code>Scope</code>模式是否仅仅在当前<code>ServiceScope</code>下具有“单例”的特性，我们先后比较了同一个<code>ServiceProvider</code>（<code>child1</code>）和不同ServiceProvider（<code>child1</code>和<code>child2</code>）两次针对服务接口<code>IBar</code>获取的实例。为了验证具有“同根”的所有<code>ServiceProvider</code>针对<code>Singleton</code>模式总是返回同一个服务实例，我们比较了两个不同<code>child1</code>和<code>child2</code>两次针对服务接口<code>IBaz</code>获取的服务实例。如下所示的输出结构印证了我们上面的论述。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ReferenceEquals(root.GetService&lt;IFoo&gt;(), root.GetService&lt;IFoo&gt;()         = False
ReferenceEquals(child1.GetService&lt;IBar&gt;(), child1.GetService&lt;IBar&gt;()     = True
ReferenceEquals(child1.GetService&lt;IBar&gt;(), child2.GetService&lt;IBar&gt;()     = False
ReferenceEquals(child1.GetService&lt;IBaz&gt;(), child2.GetService&lt;IBaz&gt;()     = True
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="_3-服务对象回收"><a href="#_3-服务对象回收" class="header-anchor">#</a> 3. 服务对象回收</h2> <p><code>ServiceProvider</code>除了为我们提供所需的服务实例之外，对于由它提供的服务实例，它还肩负起回收之责。这里所说的回收与.NET自身的垃圾回收机制无关，仅仅针对于自身类型实现了<code>IDisposable</code>接口的服务实例，所谓的回收仅仅体现为调用它们的<code>Dispose</code>方法。<code>ServiceProvider</code>针对服务实例所采用的回收策略取决于服务注册时采用的生命周期管理模式，具体采用的服务回收策略主要体现为如下两点：</p> <ul><li><code>Singleton</code>：提供<code>Disposable</code>服务实例保存在作为根容器的<code>IServiceProvider</code>对象上，只有后者被释放的时候这些<code>Disposable</code>服务实例才能被释放。</li> <li><code>Scoped</code>和<code>Transient</code>：<code>IServiceProvider</code>对象会保存由它提供的<code>Disposable</code>服务实例，当自己被释放的时候，这些<code>Disposable</code>会被释放。</li></ul> <p>综上所述，每个作为<code>DI</code>容器的<code>IServiceProvider</code>对象都具有如下图所示两个列表来存放服务实例，我们将它们分别命名为<code>Realized Services</code>和<code>Disposable Services</code>，对于一个作为非根容器的<code>IServiceProvider</code>对象来说，由它提供的<code>Scoped</code>服务保存在自身的<code>Realized Services</code>列表中，<code>Singleton</code>服务实例则会保存在根容器的<code>Realized Services</code>列表。如果服务实现类型实现了<code>IDisposable</code>接口，<code>Scoped</code>和<code>Transient</code>服务实例会被保存到自身的<code>Disposable Services</code>列表中，而<code>Singleton</code>服务实例则会保存到根容器的<code>Disposable Services</code>列表。</p> <p><img src="https://i.loli.net/2020/02/26/quHZgaCOjxEWUQt.png" alt="服务对象回收示意图"></p> <p>当<code>IServiceProvider</code>提供服务实例时，它会提取出对应的<code>ServiceDescriptor</code>对象并读取其生命周期模式。</p> <p>如果生命周期为<code>Singleton</code>，且根容器<code>Realized Services</code>列表中已包含对应的服务实例，后者将作为最终提供的服务实例。若服务实例尚未创建，那么将创建新服务对象作为提供的服务实例。返回的该服务对象将被添加到根容器<code>Realized Services</code>列表中，如果服务类型实现了<code>IDisposable</code>接口，该实例会添加到根容器的<code>Disposable Services</code>列表中。</p> <p>如果生命周期为<code>Scoped</code>，那么<code>IServiceProvider</code>会先确定自身的<code>Realized Services</code>列表中是否存在对应的服务实例，存在的服务实例将作为最终返回的服务实例。如果<code>Realized Services</code>列表不存在对应的服务实例，那么将创建新的服务实例。在最终服务实例返回之前，该实例将添加到自身的<code>Realized Services</code>列表中，如果实例类型实现了<code>IDisposable</code>接口，该实例会被添加到自身的<code>Disposable Services</code>列表中。</p> <p>如果生命周期为<code>Transient</code>，那么<code>IServiceProvider</code>会直接创建一个新的服务实例。在作为最终的服务实例被返回之前，该实例会被添到的自身的<code>Realized Services</code>列表中，如果实例类型实现了<code>IDisposable</code>接口，创建的服务实例会被添加到自身的<code>Disposable Services</code>列表中。</p> <p>对于非根容器的<code>IServiceProvider</code>对象来说，它的生命周期是由“包裹”着它的<code>IServiceScope</code>对象控制的。从上面给出的定义可以看出<code>IServiceScope</code>实现了<code>IDisposable</code>接口，<code>Dispose</code>方法的执行不仅标志着当前服务范围的终结，也意味着对应<code>IServiceProvider</code>对象生命周期的结束。一旦<code>IServiceProvider</code>因自身<code>Dispose</code>方法的调用而被释放的时候，它会从自身的<code>Disposable Services</code>列表中提取出所有需要被释放的服务实例，并调用它们的<code>Dispose</code>方法。在这之后，<code>Disposable Services</code>和<code>Realized Services</code>列表会被清空，列表中的服务实例和<code>IServiceProvider</code>对象自身会成为垃圾对象被<code>GC</code>回收。</p> <p>我们通过以下示例来体会。</p> <p>在控制台应用中定义了如下三个服务接口（<code>IFoo</code>、<code>IBar</code>和<code>IBaz</code>）以及三个实现它们的服务类（<code>Foo</code>、<code>Bar</code>和<code>Baz</code>），这些类型具有相同的基类<code>Disposable</code>。<code>Disposable</code>实现了<code>IDisposable</code>接口，我们在<code>Dispose</code>方法中输出相应的文字以确定对象回收的时机。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IFoo</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IBar</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IBaz</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Disposable</span><span class="token punctuation">,</span> <span class="token class-name">IFoo</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Disposable</span><span class="token punctuation">,</span> <span class="token class-name">IBar</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Baz</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Disposable</span><span class="token punctuation">,</span> <span class="token class-name">IBaz</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Disposable</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;{0}.Dispose()&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>我们在作为程序入口的<code>Main</code>方法中创建了一个<code>ServiceCollection</code>对象，并在其中采用不同的生命周期管理模式注册了三个相应的服务（<code>IFoo</code>/<code>Foo</code>、<code>IBar</code>/<code>Bar</code>和<code>IBaz</code>/<code>Baz</code>分别采用<code>Transient</code>、<code>Scoped</code>和<code>Singleton</code>模式）。我们针对这个<code>ServiceCollection</code>创建了一个<code>ServiceProvider</code>（<code>root</code>），以及它的两个“儿子”（<code>child1</code>和<code>child2</code>）。在分别通过<code>child1</code>和<code>child2</code>提供了两个服务实例（<code>child1：IFoo</code>， <code>child2：IBar/IBaz</code>）之后，我们先后调用三个<code>ServiceProvider</code>（<code>child1=&gt;child2=&gt;root</code>）的<code>Dispose</code>方法。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">IServiceProvider</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddTransient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoo<span class="token punctuation">,</span> Foo<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IBar<span class="token punctuation">,</span> Bar<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IBaz<span class="token punctuation">,</span> Baz<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IServiceProvider</span> child1 <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">;</span>
        <span class="token class-name">IServiceProvider</span> child2 <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">;</span>
 
        child1<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoo<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        child1<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoo<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        child2<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IBar<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        child2<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IBaz<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;child1.Dispose()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>IDisposable<span class="token punctuation">)</span>child1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;child2.Dispose()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>IDisposable<span class="token punctuation">)</span>child2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;root.Dispose()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>IDisposable<span class="token punctuation">)</span>root<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>运行该程序输出结果如下。<code>child1</code>提供的两个<code>Transient</code>模式服务实例，其回收是在<code>child1</code>的<code>Dispose</code>方法执行之后自动完成。当<code>child2</code>的<code>Dispose</code>方法被调用的时候，采用<code>Scope</code>模式的<code>Bar</code>对象被自动回收了，而采用<code>Singleton</code>模式的<code>Baz</code>对象的回收工作，是在<code>root</code>的<code>Dispose</code>方法被调用之后自动完成的。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>child1.Dispose()
Foo.Dispose()
Foo.Dispose()
child2.Dispose()
Bar.Dispose()
root.Dispose()
Baz.Dispose()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>了解<code>ServiceProvider</code>针对不同生命周期管理模式所采用的服务回收策略还会帮助我们正确的使用它。具体来说，当我们在使用一个现有的<code>ServiceProvider</code>的时候，由于我们并不能直接对它实施回收（因为它同时会在其它地方被使用），如果直接使用它来提供我们所需的服务实例，由于这些服务实例可能会在很长一段时间得不到回收，进而导致一些内存泄漏的问题。如果所用的是一个与当前应用具有相同生命周期（<code>ServiceProvider</code>在应用终止的时候才会被回收）的<code>ServiceProvider</code>，而且提供的服务采用<code>Transient</code>模式，这个问题就更加严重了，这意味着每次提供的服务实例都是一个全新的对象，但是它永远得不到回收。</p> <p>为了解决这个问题，我想很多人会想到一种解决方案，那就是按照如下所示的方式显式地对提供的每个服务实例实施回收工作。实际上这并不是一种推荐的编程方式，因为这样的做法仅仅确保了服务实例对象的<code>Dispose</code>方法能够被及时调用，但是<code>ServiceProvider</code>依然保持着对服务实例的引用，后者依然不能及时地被<code>GC</code>回收。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DoWork</span><span class="token punctuation">(</span><span class="token class-name">IServiceProvider</span> serviceProvider<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">IFoobar</span> foobar <span class="token operator">=</span> serviceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoobar<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>由于提供的服务实例总是被某个<code>ServiceProvider</code>引用着<a href="#comment">[1]</a>（直接提供服务实例的<code>ServiceProvider</code>或者是它的根），所以服务实例能够被<code>GC</code>从内存及时回收的前提是引用它的<code>ServiceProvider</code>及时地变成垃圾对象。要让提供服务实例的<code>ServiceProvider</code>成为垃圾对象，我们就必须创建一个新的<code>ServiceProvider</code>，通过上面的介绍我们知道<code>ServiceProvider</code>的创建可以通过创建<code>ServiceScope</code>的方式来实现。除此之外，我们可以通过回收<code>ServiceScope</code>的方式来回收对应的<code>ServiceProvider</code>，进而进一步回收由它提供的服务实例（仅限<code>Transient</code>和<code>Scoped</code>模式）。下面的代码片段给出了正确的编程方式。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DoWork</span><span class="token punctuation">(</span><span class="token class-name">IServiceProvider</span> serviceProvider<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">IServiceScope</span> serviceScope <span class="token operator">=</span> serviceProvider<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">IFoobar</span> foobar <span class="token operator">=</span> serviceScope<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoobar<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>接下来我们通过一个简单的实例演示上述这两种针对服务回收的编程方式之间的差异。我们在一个控制台应用中定义了一个继承自<code>IDisposable</code>的服务接口<code>IFoobar</code>和实现它的服务类<code>Foobar</code>。如下面的代码片段所示，为了确认对象真正被<code>GC</code>回收的时机，我们为<code>Foobar</code>定义了一个析构函数。在该析构函数和<code>Dispose</code>方法中，我们还会在控制台上输出相应的指导性文字。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IFoobar</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span>
<span class="token punctuation">{</span><span class="token punctuation">}</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Foobar</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IFoobar</span></span>
<span class="token punctuation">{</span>
    <span class="token operator">~</span><span class="token function">Foobar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Foobar.Finalize()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Foobar.Dispose()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>在作为程序入口的<code>Main</code>方法中，我们创建了一个<code>ServiceCollection</code>对象并采用<code>Transient</code>模式将<code>IFoobbar</code>/<code>Foobar</code>注册其中。借助于通过该<code>ServiceCollection</code>创建的<code>ServiceProvider</code>，我们分别采用上述的两种方式获取服务实例并试图对它实施回收。为了强制<code>GC</code>实时垃圾回收，我们显式调用了<code>GC</code>的<code>Collect</code>方法。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">IServiceProvider</span> serviceProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddTransient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoobar<span class="token punctuation">,</span> Foobar<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        serviceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoobar<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GC<span class="token punctuation">.</span><span class="token function">Collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;----------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">IServiceScope</span> serviceScope <span class="token operator">=</span> serviceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IServiceScopeFactory<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            serviceScope<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFoobar<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        GC<span class="token punctuation">.</span><span class="token function">Collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        Console<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>该程序执行之后会在控制台上产生如下所示的输出结果。从这个结果我们可以看出，如果我们使用现有的<code>ServiceProvider</code>来提供所需的服务实例，后者在<code>GC</code>进行垃圾回收之前并不会从内存中释放。如果我们利用现有的<code>ServiceProvider</code>创建一个<code>ServiceScope</code>，并利用它所在的<code>ServiceProvider</code>来提供我们所需的服务实例，<code>GC</code>是可以将其从内存中释放出来的。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Foobar.Dispose()
----------------
Foobar.Dispose()
Foobar.Finalize()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>另外需要注意的是，DI容器只负责释放由其创建的对象实例，我们手动创建并放到容器中的对象并不会被释放，开发中应避免以上情况。</p> <h2 id="_4-asp-net-core-服务生命周期"><a href="#_4-asp-net-core-服务生命周期" class="header-anchor">#</a> 4. Asp.Net Core 服务生命周期</h2> <p><code>DI</code>框架所谓的服务范围在ASP.NET Core应用中具有明确的边界，指的是针对每个HTTP请求的上下文，也就是服务范围的生命周期与每个请求上下文绑定在一起。如下图所示，ASP.NET Core应用中用于提供服务实例的<code>IServiceProvider</code>对象分为两种类型，一种是作为根容器并与应用具有相同生命周期的<code>IServiceProvider</code>，另一个类则是根据请求及时创建和释放的<code>IServiceProvider</code>，我们可以将它们分别称为<code>Application ServiceProvider</code>和<code>Request ServiceProvider</code>。</p> <p><img src="https://i.loli.net/2020/02/26/QoOeufjVxMagdcr.png" alt="Asp.Net Core 服务生命周期"></p> <p>在ASP.NET Core应用初始化过程中，即请求管道构建过程中使用的服务实例都是由<code>Application ServiceProvider</code>提供的。在具体处理每个请求时，ASP.NET Core框架会利用注册的一个中间件来针对当前请求创建一个服务范围，该服务范围提供的<code>Request ServiceProvider</code>用来提供当前请求处理过程中所需的服务实例。一旦服务请求处理完成，上述的这个中间件会主动释放掉由它创建的服务范围。</p> <h2 id="_5-asp-net-core-服务范围检验"><a href="#_5-asp-net-core-服务范围检验" class="header-anchor">#</a> 5. ASP.NET Core 服务范围检验</h2> <p>如果我们在一个ASP.NET Core应用中将一个服务的生命周期注册为<code>Scoped</code>，实际上是希望服务实例采用基于请求的生命周期。</p> <p>假定以下场景。</p> <p>在一个ASP.NET Core应用中采用<code>Entity Framework Core</code>来访问数据库，我们一般会将对应的<code>DbContext</code>类型（姑且命名为<code>FoobarDbContext</code>）注册为一个<code>Scoped</code>服务，这样既可以保证在<code>FoobarDbContext</code>能够在同一个请求上下文中被重用，也可以确保<code>FoobarDbContext</code>在请求结束之后能够及时将数据库链接释放掉。</p> <p>假定有另一个<code>Singleton</code>服务（姑且命名为<code>Foobar</code>）具有针对<code>FoobarDbContext</code>的依赖。由于<code>Foobar</code>是一个<code>Singleton</code>服务实例，所以被它引用的<code>FoobarDbContext</code>也只能在应用关闭的时候才能被释放。</p> <p>为了解决以上这个问题，可以让<code>IServiceProvider</code>在提供<code>Scoped</code>服务实例的时候进行针对性的检验。针对服务范围验证的开关由<code>ServiceProviderOptions</code>的<code>ValidateScopes</code>属性来控制，默认情况下是关闭的。如果希望开启针对服务范围的验证，我们可以在调用<code>IServiceCollection</code>接口的<code>BuildServiceProvider</code>方法的时候指定一个<code>ServiceProviderOptions</code>对象作为参数，或者直接调用另一个扩展方法并将传入的参数<code>validateScopes</code>设置为<code>True</code>。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceProviderOptions</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> ValidateScopes <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ServiceCollectionContainerBuilderExtensions</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">ServiceProvider</span> <span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name">ServiceProviderOptions</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">ServiceProvider</span> <span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">bool</span></span> validateScopes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>针对服务范围的验证对于<code>IServiceProvider</code>来说是一项额外附加的操作，会对性能带来或多或少的影响，所以一般情况下这个开关只会在开发（<code>Development</code>）环境被开启，对于产品（<code>Production</code>）或者预发（<code>Staging</code>）环境下最好将其关闭。</p> <small id="comment">
[1] 对于分别采用 Scoped和Singleton模式提供的服务实例，当前ServiceProvider和根ServiceProvider分别具有对它们的引用。如果采用Transient模式，只有服务类型实现了IDisposable接口，当前ServiceProvider才需要对它保持引用以完成对它们的回收，否则没有任何一个ServiceProvider保持对它们的引用。
</small> <blockquote><p>参考文献</p></blockquote> <ul><li>http://www.cnblogs.com/artech/p/asp-net-core-di-life-time.html</li> <li>https://www.cnblogs.com/artech/p/net-core-di-08.html</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/26/2021, 2:25:24 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/dotnet/di/consume.html" class="prev">
        .Net Core 服务消费
      </a></span> <span class="next"><a href="/dotnet/di/aspnet.html">
        Asp.Net Core 依赖注入使用
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/dotnet/assets/js/app.4e9b76c2.js" defer></script><script src="/dotnet/assets/js/2.86915a18.js" defer></script><script src="/dotnet/assets/js/29.2490c8c9.js" defer></script>
  </body>
</html>
