<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>EF Core 基础 | .Net 实战笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="https://i.loli.net/2020/02/25/AOjBhkIxtb8dRgl.png">
    <meta name="description" content="熟知.NET Core核心组件设计原理;基于DDD开发云原生微服务应用;掌握.NET Core工程设计最佳实践;提升K8s微服务部署与维护技能">
    
    <link rel="preload" href="/dotnet/assets/css/0.styles.7248ee20.css" as="style"><link rel="preload" href="/dotnet/assets/js/app.4e9b76c2.js" as="script"><link rel="preload" href="/dotnet/assets/js/2.86915a18.js" as="script"><link rel="preload" href="/dotnet/assets/js/23.6c8b869e.js" as="script"><link rel="prefetch" href="/dotnet/assets/js/10.7f9feb78.js"><link rel="prefetch" href="/dotnet/assets/js/11.43be2bc7.js"><link rel="prefetch" href="/dotnet/assets/js/12.e8c0fca4.js"><link rel="prefetch" href="/dotnet/assets/js/13.08e3036f.js"><link rel="prefetch" href="/dotnet/assets/js/14.6424aec3.js"><link rel="prefetch" href="/dotnet/assets/js/15.4d39118d.js"><link rel="prefetch" href="/dotnet/assets/js/16.e2287734.js"><link rel="prefetch" href="/dotnet/assets/js/17.82266a75.js"><link rel="prefetch" href="/dotnet/assets/js/18.e3676b0a.js"><link rel="prefetch" href="/dotnet/assets/js/19.d7bd221d.js"><link rel="prefetch" href="/dotnet/assets/js/20.b8cf0f4e.js"><link rel="prefetch" href="/dotnet/assets/js/21.c5bcd1a9.js"><link rel="prefetch" href="/dotnet/assets/js/22.6fc7c7b2.js"><link rel="prefetch" href="/dotnet/assets/js/24.a831f9ed.js"><link rel="prefetch" href="/dotnet/assets/js/25.62b16105.js"><link rel="prefetch" href="/dotnet/assets/js/26.d88ba3e3.js"><link rel="prefetch" href="/dotnet/assets/js/27.f420e029.js"><link rel="prefetch" href="/dotnet/assets/js/28.fb34a308.js"><link rel="prefetch" href="/dotnet/assets/js/29.2490c8c9.js"><link rel="prefetch" href="/dotnet/assets/js/3.20bab2d8.js"><link rel="prefetch" href="/dotnet/assets/js/30.7b53e293.js"><link rel="prefetch" href="/dotnet/assets/js/31.97da4974.js"><link rel="prefetch" href="/dotnet/assets/js/32.6d3ad1a3.js"><link rel="prefetch" href="/dotnet/assets/js/33.3da29db6.js"><link rel="prefetch" href="/dotnet/assets/js/34.089e1fb3.js"><link rel="prefetch" href="/dotnet/assets/js/35.5f60b6ee.js"><link rel="prefetch" href="/dotnet/assets/js/36.cc872073.js"><link rel="prefetch" href="/dotnet/assets/js/37.e1ebcf4e.js"><link rel="prefetch" href="/dotnet/assets/js/38.bab59cca.js"><link rel="prefetch" href="/dotnet/assets/js/39.a39d6eae.js"><link rel="prefetch" href="/dotnet/assets/js/4.1363a917.js"><link rel="prefetch" href="/dotnet/assets/js/40.fae7fbb6.js"><link rel="prefetch" href="/dotnet/assets/js/41.5c5ffdf9.js"><link rel="prefetch" href="/dotnet/assets/js/42.0968c3b8.js"><link rel="prefetch" href="/dotnet/assets/js/43.e0cdc7be.js"><link rel="prefetch" href="/dotnet/assets/js/44.597b492a.js"><link rel="prefetch" href="/dotnet/assets/js/45.5e800e70.js"><link rel="prefetch" href="/dotnet/assets/js/46.527ac987.js"><link rel="prefetch" href="/dotnet/assets/js/47.6e336667.js"><link rel="prefetch" href="/dotnet/assets/js/48.5cf812b1.js"><link rel="prefetch" href="/dotnet/assets/js/49.f3403fdb.js"><link rel="prefetch" href="/dotnet/assets/js/5.e6eb57b9.js"><link rel="prefetch" href="/dotnet/assets/js/50.53f4771b.js"><link rel="prefetch" href="/dotnet/assets/js/51.a4151538.js"><link rel="prefetch" href="/dotnet/assets/js/52.0e39eecc.js"><link rel="prefetch" href="/dotnet/assets/js/53.7fefff6f.js"><link rel="prefetch" href="/dotnet/assets/js/54.e11d2956.js"><link rel="prefetch" href="/dotnet/assets/js/55.77862968.js"><link rel="prefetch" href="/dotnet/assets/js/56.031c2977.js"><link rel="prefetch" href="/dotnet/assets/js/57.e1f250f4.js"><link rel="prefetch" href="/dotnet/assets/js/58.f84112be.js"><link rel="prefetch" href="/dotnet/assets/js/59.771eb349.js"><link rel="prefetch" href="/dotnet/assets/js/6.a9924f8b.js"><link rel="prefetch" href="/dotnet/assets/js/7.da95d574.js"><link rel="prefetch" href="/dotnet/assets/js/8.c208d4c3.js"><link rel="prefetch" href="/dotnet/assets/js/9.4de8d1ac.js">
    <link rel="stylesheet" href="/dotnet/assets/css/0.styles.7248ee20.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/dotnet/" class="home-link router-link-active"><!----> <span class="site-name">.Net 实战笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/dotnet/basic/introduction.html" class="nav-link">
  Get Start
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow down"></span></button> <button type="button" aria-label="Books" class="mobile-dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/python" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Python
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/linux" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Linux
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/architecture" target="_blank" rel="noopener noreferrer" class="nav-link external">
  系统架构设计
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://ccstudio.com.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/colin-chang/dotnet" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/dotnet/basic/introduction.html" class="nav-link">
  Get Start
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow down"></span></button> <button type="button" aria-label="Books" class="mobile-dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/python" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Python
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/linux" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Linux
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/architecture" target="_blank" rel="noopener noreferrer" class="nav-link external">
  系统架构设计
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://ccstudio.com.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/colin-chang/dotnet" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>.Net基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>依赖注入</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>文件系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>配置选项</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>日志框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>承载系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>管道</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>静态文件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>路由</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>异常处理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>缓存</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>会话</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>认证授权</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>IdentityServer</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>数据访问</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dotnet/data_access/efcore.html" aria-current="page" class="active sidebar-link">EF Core 基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/data_access/efcore.html#_1-ef-core-简介" class="sidebar-link">1. EF Core 简介</a></li><li class="sidebar-sub-header"><a href="/dotnet/data_access/efcore.html#_2-quick-start" class="sidebar-link">2. Quick Start</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/data_access/efcore.html#_2-1-安装" class="sidebar-link">2.1 安装</a></li><li class="sidebar-sub-header"><a href="/dotnet/data_access/efcore.html#_2-2-模型" class="sidebar-link">2.2 模型</a></li><li class="sidebar-sub-header"><a href="/dotnet/data_access/efcore.html#_2-3-迁移数据库" class="sidebar-link">2.3 迁移数据库</a></li><li class="sidebar-sub-header"><a href="/dotnet/data_access/efcore.html#_2-4-crud" class="sidebar-link">2.4 CRUD</a></li></ul></li></ul></li><li><a href="/dotnet/data_access/dapper.html" class="sidebar-link">Dapper</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/data_access/dapper.html#_1-简介" class="sidebar-link">1. 简介</a></li><li class="sidebar-sub-header"><a href="/dotnet/data_access/dapper.html#_2-项目-模型" class="sidebar-link">2. 项目/模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/data_access/dapper.html#_2-1-创建项目" class="sidebar-link">2.1 创建项目</a></li><li class="sidebar-sub-header"><a href="/dotnet/data_access/dapper.html#_2-2-数据模型" class="sidebar-link">2.2 数据模型</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/data_access/dapper.html#_3-crud" class="sidebar-link">3. CRUD</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/data_access/dapper.html#_3-1-非查询操作" class="sidebar-link">3.1 非查询操作</a></li><li class="sidebar-sub-header"><a href="/dotnet/data_access/dapper.html#_3-2-查询操作" class="sidebar-link">3.2 查询操作</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/data_access/dapper.html#_3-事务和存储过程" class="sidebar-link">3. 事务和存储过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/data_access/dapper.html#_3-1-事务" class="sidebar-link">3.1 事务</a></li><li class="sidebar-sub-header"><a href="/dotnet/data_access/dapper.html#_3-2-存储过程" class="sidebar-link">3.2 存储过程</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/data_access/dapper.html#_4-其它" class="sidebar-link">4. 其它</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/data_access/dapper.html#_4-1-参数替换" class="sidebar-link">4.1 参数替换</a></li><li class="sidebar-sub-header"><a href="/dotnet/data_access/dapper.html#_4-2-缓存查询" class="sidebar-link">4.2 缓存查询</a></li><li class="sidebar-sub-header"><a href="/dotnet/data_access/dapper.html#_4-3-ansi编码" class="sidebar-link">4.3 ANSI编码</a></li><li class="sidebar-sub-header"><a href="/dotnet/data_access/dapper.html#_4-4-多数据类型行" class="sidebar-link">4.4 多数据类型行</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/data_access/dapper.html#_5-dapperhelper" class="sidebar-link">5. DapperHelper</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>WebAPI</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>跨域资源共享</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>本地化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>健康检查</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其它主题</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ef-core-基础"><a href="#ef-core-基础" class="header-anchor">#</a> EF Core 基础</h1> <h2 id="_1-ef-core-简介"><a href="#_1-ef-core-简介" class="header-anchor">#</a> 1. EF Core 简介</h2> <p><code>Entity Framework Core</code>是轻量化、可扩展、开源和跨平台版的常用<code>Entity Framework</code>数据访问技术。
<code>EF Core</code>可用作对象关系映射程序 (O/RM)，这可以实现以下两点：</p> <ul><li>使 .NET 开发人员能够使用 .NET 对象处理数据库。</li> <li>无需再像通常那样编写大部分数据访问代码。
<code>EF Core</code>支持多个数据库引擎。</li></ul> <p>这里我们只是对EF做一点简单的介绍，更多详细内容请参阅其<a href="https://docs.microsoft.com/zh-cn/ef/core/" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="_2-quick-start"><a href="#_2-quick-start" class="header-anchor">#</a> 2. Quick Start</h2> <h3 id="_2-1-安装"><a href="#_2-1-安装" class="header-anchor">#</a> 2.1 安装</h3> <p><code>EF Core</code>是一个<code>.NET Standard</code>库。 因此，<code>EF Core</code>需要支持运行<code>.NET Standard</code>的实现。 其它<code>.NET Standard</code>库也可引用<code>EF Core</code>。要将<code>EF Core</code>添加到应用程序，请安装适用于要使用的数据库提供程序的NuGet包，它会自动依赖引入需要用到的<code>EF Core</code>的基础包。</p> <table><thead><tr><th style="text-align:left;">数据库系统</th> <th style="text-align:left;">NuGet 程序包</th></tr></thead> <tbody><tr><td style="text-align:left;">SQL Server / Azure SQL</td> <td style="text-align:left;"><a href="https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.SqlServer/" target="_blank" rel="noopener noreferrer">Microsoft.EntityFrameworkCore.SqlServer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td style="text-align:left;">MySQL / MariaDB</td> <td style="text-align:left;"><a href="https://www.nuget.org/packages/Pomelo.EntityFrameworkCore.MySql/" target="_blank" rel="noopener noreferrer">Pomelo.EntityFrameworkCore.MySql<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td style="text-align:left;">PostgreSQL</td> <td style="text-align:left;"><a href="https://www.nuget.org/packages/Npgsql.EntityFrameworkCore.PostgreSQL/" target="_blank" rel="noopener noreferrer">Npgsql.EntityFrameworkCore.PostgreSQL<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td style="text-align:left;">Oracle</td> <td style="text-align:left;"><a href="https://www.nuget.org/packages/Oracle.EntityFrameworkCore/" target="_blank" rel="noopener noreferrer">Oracle.EntityFrameworkCore<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td style="text-align:left;">SQLite</td> <td style="text-align:left;"><a href="https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.Sqlite/" target="_blank" rel="noopener noreferrer">	Microsoft.EntityFrameworkCore.Sqlite<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr></tbody></table> <h3 id="_2-2-模型"><a href="#_2-2-模型" class="header-anchor">#</a> 2.2 模型</h3> <p><code>EF Core</code>使用模型执行数据访问。模型由实体类和表示数据库会话的上下文对象构成。</p> <p>本节示例项目代码已共享至<a href="https://github.com/colin-chang/EfDemo" target="_blank" rel="noopener noreferrer">Github<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h4 id="_1-实体"><a href="#_1-实体" class="header-anchor">#</a> 1) 实体</h4> <p><code>EF Core</code>章节中我们使用下图所示实体为例进行简单的讲解和演示，数据库采用Mysql 8。
<img src="https://i.loli.net/2021/02/06/iSmeUVH7ZLDg6TK.png" alt="实体关系图"></p> <p>默认不做任何限定的情况下，<code>EF Core</code>迁移数据库时会使用各数据类型的最大值，我们可以通过<code>Annotation Attribute</code>来约束实体属性,比如设置非空，长度，非默认数据类型，非默认名称等，示例如下。</p> <div class="language-csharp line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-csharp"><code><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 俱乐部</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Club</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Required</span><span class="token punctuation">,</span> <span class="token class-name">MaxLength</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MaxLength</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> City <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Column</span><span class="token attribute-arguments"><span class="token punctuation">(</span>TypeName <span class="token operator">=</span> <span class="token string">&quot;date&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> <span class="token comment">// 自定义类型，默认情况为 datetime</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> EstablishedDate <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MaxLength</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> 
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> History <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 所属联盟</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">League</span> League <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 俱乐部球员</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>Player<span class="token punctuation">&gt;</span></span> Players <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Player<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>除了<code>Annotation Attribute</code>方式，我们也可以在上下<code>OnModelCreating</code>中使用<code>fluent API</code>配置模型。<strong>此配置方法最为有效，并可在不修改实体类的情况下指定配置。 Fluent API 配置具有最高优先级，并将替代约定和数据注释。</strong></p> <div class="language-csharp line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnModelCreating</span><span class="token punctuation">(</span><span class="token class-name">ModelBuilder</span> modelBuilder<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        modelBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Entity</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Game<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>g <span class="token operator">=&gt;</span> g<span class="token punctuation">.</span>Round<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">IsRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>实体间 <code>1:1</code>和<code>1:N</code>的关系都可以任意一方或双方通过导航属性体现，数据迁移时就会自动建立表的物理外键关联。<code>M:N</code>的关系则需要建立中间关系表，双方与中间关系表是两个<code>1:N</code>的关系。</p> <h4 id="_2-dbcontext"><a href="#_2-dbcontext" class="header-anchor">#</a> 2）DbContext</h4> <h4 id="_1-code-first"><a href="#_1-code-first" class="header-anchor">#</a> ① Code First</h4> <p>EF Core常用以下模型开发方法：</p> <ul><li>从现有数据库生成模型，或对模型手动编码，使其符合数据库。</li> <li>创建模型后，使用EF迁移从模型创建数据库。</li></ul> <p>第一种方式就是我们常说的<code>DB First</code>，市面上大多以数据库为核心的体量不大的系统多采用这种方式进行开发。</p> <p>后面一种则称为<code>Code First</code>，此方式以业务为核心进而抽象成模型，最后通过模型迁移数据库，模型发生变化时，迁移可让数据库不断演进。这也是领域驱动设计(DDD)推荐的开发方式，众所周知，DDD正是当下最流行的服务架构设计思想，<code>Code First</code>正是其推崇的以业务为核心的设计思路的落地。</p> <h4 id="_2-配置数据库提供程序"><a href="#_2-配置数据库提供程序" class="header-anchor">#</a> ② 配置数据库提供程序</h4> <p>下面示例采用<code>Code First</code>，首先手动创建一个数据库会话上下文<code>DemoContext</code>并继承自<code>DbContext</code>用于执行数据交互，每一个实体的数据集作为<code>DbSet&lt;T&gt;</code>属性最终映射为数据表。数据库的相应配置则可以在重写上下文的<code>OnConfiguring</code>方法中指定。</p> <div class="language-csharp line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoContext</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DbContext</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> ConnectionString <span class="token operator">=</span> <span class="token string">&quot;Server=127.0.0.1;Port=3306;Database=demo;User=root;Password=123123;&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnConfiguring</span><span class="token punctuation">(</span><span class="token class-name">DbContextOptionsBuilder</span> optionsBuilder<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        optionsBuilder<span class="token punctuation">.</span><span class="token function">UseMySql</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">,</span> ServerVersion<span class="token punctuation">.</span><span class="token function">AutoDetect</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>League<span class="token punctuation">&gt;</span></span> Leagues <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>Club<span class="token punctuation">&gt;</span></span> Clubs <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DbSet<span class="token punctuation">&lt;</span>Player<span class="token punctuation">&gt;</span></span> Players <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>如果系统程序入口为Asp.Net Core或WorkService等则会使用DI方式管理EF Core等服务组件，那EF Core的配置会在服务注入时设置而不需要在<code>OnConfiguring</code>中设置了。</p> <div class="language-csharp line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContext</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>DemoContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
            options<span class="token punctuation">.</span><span class="token function">UseMySql</span><span class="token punctuation">(</span>Configuration<span class="token punctuation">.</span><span class="token function">GetConnectionString</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>DemoContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ServerVersion<span class="token punctuation">.</span><span class="token function">AutoDetect</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_3-dbcontext生命周期"><a href="#_3-dbcontext生命周期" class="header-anchor">#</a> ③ DbContext生命周期</h4> <ul><li><code>DbContext</code>实例旨在用于单个工作单元，意味着<code>DbContext</code>实例的生存期通常很短。在Web应用中，每个HTTP请求都对应于单个工作单元，当请求结束是<code>DbContext</code>实例将被释放。</li> <li>使用后释放<code>DbContext</code>非常重要。 这可确保释放所有非托管资源，并注销任何事件或其它挂钩，以防止在实例保持引用时出现内存泄漏。</li> <li><code>DbContext</code>不是线程安全的。 不要在线程之间共享上下文。请确保在继续使用上下文实例之前，等待所有异步调用。</li></ul> <p><strong>EF Core不支持在同一DbContext实例上运行多个并行操作。</strong> 这包括异步查询的并行执行以及从多个线程进行的任何显式并发使用。 因此，始终立即<code>await</code>异步调用，或对并行执行的操作使用单独的 <code>DbContext</code>实例。</p> <h3 id="_2-3-迁移数据库"><a href="#_2-3-迁移数据库" class="header-anchor">#</a> 2.3 迁移数据库</h3> <p>模型定义完成后就可以使用<code>dotnet-ef</code>工具创建<code>Migration</code>文件并应用和更新到数据库。</p> <p>migration等EF Core工具命令需要在<a href="https://docs.microsoft.com/zh-cn/ef/core/cli/dbcontext-creation?tabs=dotnet-core-cli" target="_blank" rel="noopener noreferrer"><code>DbContext</code>设计时<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>创建一个派生实例，以便收集有关该应用程序的实体类型及其如何映射到数据库架构的详细信息。</p> <p>数据库迁移文件需要依赖一个可执行程序，如果模型所在项目是一个类库等非可执行程序那需要通过<code>-s</code>参数指定一个可执行程序，并且可执行程序中要安装<code>Microsoft.EntityFrameworkCore.Design</code>。</p> <h4 id="_1-dotnet-ef"><a href="#_1-dotnet-ef" class="header-anchor">#</a> 1) dotnet-ef</h4> <p>首次使用时需要先安装<code>dotnet-ef</code>工具。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 安装</span>
dotnet tool <span class="token function">install</span> -g dotnet-ef
<span class="token comment"># 更新</span>
dotnet tool update -g dotnet-ef
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_2-nuget"><a href="#_2-nuget" class="header-anchor">#</a> 2) nuget</h4> <p>首次迁移需要在项目中引用<a href="https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.Design/" target="_blank" rel="noopener noreferrer">Microsoft.EntityFrameworkCore.Design<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>`</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>dotnet <span class="token function">add</span> package Microsoft.EntityFrameworkCore.Design
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_3-创建migration文件"><a href="#_3-创建migration文件" class="header-anchor">#</a> 3) 创建Migration文件</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># InitialCreate 为本次迁移的名称，生成迁移文件时会以此关键字创建迁移和相关文件，所以建议使用大驼峰命名</span>

<span class="token comment"># 可执行程序</span>
dotnet ef migrations <span class="token function">add</span> InitialCreate
<span class="token comment"># 非可执行程序</span>
dotnet ef migrations <span class="token function">add</span> InitialCreate -s <span class="token punctuation">..</span>/EfDemo.App/EfDemo.App.csproj
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>初次执行以上命令会在当前项目下生成<code>Migrations</code>目录并生成类似<code>xxx_InitialCreate.cs</code>和<code>DemoContextModelSnapshot.cs</code>的两个文件。前者带时间戳的文件是本次迁移对应的文件，而后者则是一个数据快照，<code>EF Core</code>以此来追踪模型状态。当模型变化后再次迁移数据库时，<code>EF Core</code>会对比快照文件来确定数据库的变化差异进。</p> <p>迁移文件中包含一个我们命名的<code>Migration</code>子类，其中重写了<code>Up</code>/<code>Down</code>两个方法，前者用于对数据库进行修改，后者则是对修改的回滚。</p> <p>如果要撤销迁移文件创建操作可以通过以下命令。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>dotnet ef migrations remove -s <span class="token punctuation">..</span>/EfDemo.App/EfDemo.App.csproj
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_4-更新数据库"><a href="#_4-更新数据库" class="header-anchor">#</a> 4) 更新数据库</h4> <p>生产环境中我们可以通过以下指令根据迁移文件生成SQL脚本，然后交由DBA执行SQL脚本更新数据库。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>dotnet ef migrations script -o Migrations/InitialCreate.sql -s <span class="token punctuation">..</span>/EfDemo.App/EfDemo.App.csproj
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在开发环境中我们通常会跳过脚本生成，直接通过以下指令将迁移文件直接应用到数据库。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>dotnet ef database update -s <span class="token punctuation">..</span>/EfDemo.App/EfDemo.App.csproj
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>需要注意的是，<code>EF Core</code>迁移数据库时除了实体模型对应的数据表外，还会自动生成一个<code>__EFMigrationsHistory</code>表用于记录数据库历史记录。</p> <h3 id="_2-4-crud"><a href="#_2-4-crud" class="header-anchor">#</a> 2.4 CRUD</h3> <p>dotnet ef migrations remove -s ../EfDemo.App/EfDemo.App.csproj</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/19/2021, 3:41:48 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/dotnet/identity_server/third_party.html" class="prev">
        第三方登录
      </a></span> <span class="next"><a href="/dotnet/data_access/dapper.html">
        Dapper
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/dotnet/assets/js/app.4e9b76c2.js" defer></script><script src="/dotnet/assets/js/2.86915a18.js" defer></script><script src="/dotnet/assets/js/23.6c8b869e.js" defer></script>
  </body>
</html>
