<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>授权 | .Net 实战笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="https://i.loli.net/2020/02/25/AOjBhkIxtb8dRgl.png">
    <meta name="description" content="熟知.NET Core核心组件设计原理;基于DDD开发云原生微服务应用;掌握.NET Core工程设计最佳实践;提升K8s微服务部署与维护技能">
    
    <link rel="preload" href="/dotnet/assets/css/0.styles.7248ee20.css" as="style"><link rel="preload" href="/dotnet/assets/js/app.4e9b76c2.js" as="script"><link rel="preload" href="/dotnet/assets/js/2.86915a18.js" as="script"><link rel="preload" href="/dotnet/assets/js/13.08e3036f.js" as="script"><link rel="prefetch" href="/dotnet/assets/js/10.7f9feb78.js"><link rel="prefetch" href="/dotnet/assets/js/11.43be2bc7.js"><link rel="prefetch" href="/dotnet/assets/js/12.e8c0fca4.js"><link rel="prefetch" href="/dotnet/assets/js/14.6424aec3.js"><link rel="prefetch" href="/dotnet/assets/js/15.4d39118d.js"><link rel="prefetch" href="/dotnet/assets/js/16.e2287734.js"><link rel="prefetch" href="/dotnet/assets/js/17.82266a75.js"><link rel="prefetch" href="/dotnet/assets/js/18.e3676b0a.js"><link rel="prefetch" href="/dotnet/assets/js/19.d7bd221d.js"><link rel="prefetch" href="/dotnet/assets/js/20.b8cf0f4e.js"><link rel="prefetch" href="/dotnet/assets/js/21.c5bcd1a9.js"><link rel="prefetch" href="/dotnet/assets/js/22.6fc7c7b2.js"><link rel="prefetch" href="/dotnet/assets/js/23.6c8b869e.js"><link rel="prefetch" href="/dotnet/assets/js/24.a831f9ed.js"><link rel="prefetch" href="/dotnet/assets/js/25.62b16105.js"><link rel="prefetch" href="/dotnet/assets/js/26.d88ba3e3.js"><link rel="prefetch" href="/dotnet/assets/js/27.f420e029.js"><link rel="prefetch" href="/dotnet/assets/js/28.fb34a308.js"><link rel="prefetch" href="/dotnet/assets/js/29.2490c8c9.js"><link rel="prefetch" href="/dotnet/assets/js/3.20bab2d8.js"><link rel="prefetch" href="/dotnet/assets/js/30.7b53e293.js"><link rel="prefetch" href="/dotnet/assets/js/31.97da4974.js"><link rel="prefetch" href="/dotnet/assets/js/32.6d3ad1a3.js"><link rel="prefetch" href="/dotnet/assets/js/33.3da29db6.js"><link rel="prefetch" href="/dotnet/assets/js/34.089e1fb3.js"><link rel="prefetch" href="/dotnet/assets/js/35.5f60b6ee.js"><link rel="prefetch" href="/dotnet/assets/js/36.cc872073.js"><link rel="prefetch" href="/dotnet/assets/js/37.e1ebcf4e.js"><link rel="prefetch" href="/dotnet/assets/js/38.bab59cca.js"><link rel="prefetch" href="/dotnet/assets/js/39.a39d6eae.js"><link rel="prefetch" href="/dotnet/assets/js/4.1363a917.js"><link rel="prefetch" href="/dotnet/assets/js/40.fae7fbb6.js"><link rel="prefetch" href="/dotnet/assets/js/41.5c5ffdf9.js"><link rel="prefetch" href="/dotnet/assets/js/42.0968c3b8.js"><link rel="prefetch" href="/dotnet/assets/js/43.e0cdc7be.js"><link rel="prefetch" href="/dotnet/assets/js/44.597b492a.js"><link rel="prefetch" href="/dotnet/assets/js/45.5e800e70.js"><link rel="prefetch" href="/dotnet/assets/js/46.527ac987.js"><link rel="prefetch" href="/dotnet/assets/js/47.6e336667.js"><link rel="prefetch" href="/dotnet/assets/js/48.5cf812b1.js"><link rel="prefetch" href="/dotnet/assets/js/49.f3403fdb.js"><link rel="prefetch" href="/dotnet/assets/js/5.e6eb57b9.js"><link rel="prefetch" href="/dotnet/assets/js/50.53f4771b.js"><link rel="prefetch" href="/dotnet/assets/js/51.a4151538.js"><link rel="prefetch" href="/dotnet/assets/js/52.0e39eecc.js"><link rel="prefetch" href="/dotnet/assets/js/53.7fefff6f.js"><link rel="prefetch" href="/dotnet/assets/js/54.e11d2956.js"><link rel="prefetch" href="/dotnet/assets/js/55.77862968.js"><link rel="prefetch" href="/dotnet/assets/js/56.031c2977.js"><link rel="prefetch" href="/dotnet/assets/js/57.e1f250f4.js"><link rel="prefetch" href="/dotnet/assets/js/58.f84112be.js"><link rel="prefetch" href="/dotnet/assets/js/59.771eb349.js"><link rel="prefetch" href="/dotnet/assets/js/6.a9924f8b.js"><link rel="prefetch" href="/dotnet/assets/js/7.da95d574.js"><link rel="prefetch" href="/dotnet/assets/js/8.c208d4c3.js"><link rel="prefetch" href="/dotnet/assets/js/9.4de8d1ac.js">
    <link rel="stylesheet" href="/dotnet/assets/css/0.styles.7248ee20.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/dotnet/" class="home-link router-link-active"><!----> <span class="site-name">.Net 实战笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/dotnet/basic/introduction.html" class="nav-link">
  Get Start
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow down"></span></button> <button type="button" aria-label="Books" class="mobile-dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/python" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Python
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/linux" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Linux
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/architecture" target="_blank" rel="noopener noreferrer" class="nav-link external">
  系统架构设计
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://ccstudio.com.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/colin-chang/dotnet" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/dotnet/basic/introduction.html" class="nav-link">
  Get Start
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Books" class="dropdown-title"><span class="title">Books</span> <span class="arrow down"></span></button> <button type="button" aria-label="Books" class="mobile-dropdown-title"><span class="title">Books</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/python" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Python
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/linux" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Linux
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ccstudio.com.cn/architecture" target="_blank" rel="noopener noreferrer" class="nav-link external">
  系统架构设计
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://ccstudio.com.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/colin-chang/dotnet" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>.Net基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>依赖注入</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>文件系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>配置选项</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>日志框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>承载系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>管道</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>静态文件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>路由</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>异常处理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>缓存</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>会话</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>认证授权</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dotnet/auth/authentication.html" class="sidebar-link">认证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/auth/authentication.html#_1-身份与用户" class="sidebar-link">1. 身份与用户</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/auth/authentication.html#_1-1-身份" class="sidebar-link">1.1 身份</a></li><li class="sidebar-sub-header"><a href="/dotnet/auth/authentication.html#_1-2-用户" class="sidebar-link">1.2 用户</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/auth/authentication.html#_2-认证模型" class="sidebar-link">2. 认证模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/auth/authentication.html#_2-1-认证票据" class="sidebar-link">2.1 认证票据</a></li><li class="sidebar-sub-header"><a href="/dotnet/auth/authentication.html#_2-2-认证处理器" class="sidebar-link">2.2 认证处理器</a></li><li class="sidebar-sub-header"><a href="/dotnet/auth/authentication.html#_2-3-认证服务" class="sidebar-link">2.3 认证服务</a></li><li class="sidebar-sub-header"><a href="/dotnet/auth/authentication.html#_2-4-认证中间件" class="sidebar-link">2.4 认证中间件</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/auth/authentication.html#_3-认证案例" class="sidebar-link">3. 认证案例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/auth/authentication.html#_3-1-认证示例" class="sidebar-link">3.1 认证示例</a></li><li class="sidebar-sub-header"><a href="/dotnet/auth/authentication.html#_3-2-框架解析" class="sidebar-link">3.2 框架解析</a></li></ul></li></ul></li><li><a href="/dotnet/auth/authorize.html" aria-current="page" class="active sidebar-link">授权</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/auth/authorize.html#_1-基于-要求-的授权" class="sidebar-link">1. 基于“要求”的授权</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/auth/authorize.html#_1-1-iauthorizationrequirement" class="sidebar-link">1.1 IAuthorizationRequirement</a></li><li class="sidebar-sub-header"><a href="/dotnet/auth/authorize.html#_1-2-预定义iauthorizationrequirement" class="sidebar-link">1.2 预定义IAuthorizationRequirement</a></li><li class="sidebar-sub-header"><a href="/dotnet/auth/authorize.html#_1-3-授权服务" class="sidebar-link">1.3 授权服务</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/auth/authorize.html#_2-基于-策略-的授权" class="sidebar-link">2. 基于“策略”的授权</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/auth/authorize.html#_2-1-构建授权策略" class="sidebar-link">2.1 构建授权策略</a></li><li class="sidebar-sub-header"><a href="/dotnet/auth/authorize.html#_2-2-注册授权策略" class="sidebar-link">2.2 注册授权策略</a></li><li class="sidebar-sub-header"><a href="/dotnet/auth/authorize.html#_2-3-授权检验" class="sidebar-link">2.3 授权检验</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/auth/authorize.html#_3-授权案例" class="sidebar-link">3. 授权案例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/auth/authorize.html#_3-1-基于-要求-的角色授权" class="sidebar-link">3.1 基于“要求”的角色授权</a></li><li class="sidebar-sub-header"><a href="/dotnet/auth/authorize.html#_3-2-基于-策略-的角色授权" class="sidebar-link">3.2 基于“策略”的角色授权</a></li><li class="sidebar-sub-header"><a href="/dotnet/auth/authorize.html#_3-3-授权中间件与mvc过滤器" class="sidebar-link">3.3 授权中间件与MVC过滤器</a></li></ul></li></ul></li><li><a href="/dotnet/auth/jwt.html" class="sidebar-link">JWT</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/auth/jwt.html#_1-jwt-token" class="sidebar-link">1. JWT Token</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/auth/jwt.html#_1-1-jwt-认证" class="sidebar-link">1.1 JWT 认证</a></li><li class="sidebar-sub-header"><a href="/dotnet/auth/jwt.html#_1-2-jwt与session" class="sidebar-link">1.2 JWT与Session</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/auth/jwt.html#_2-jwt结构" class="sidebar-link">2. JWT结构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/auth/jwt.html#_2-1-header" class="sidebar-link">2.1 Header</a></li><li class="sidebar-sub-header"><a href="/dotnet/auth/jwt.html#_2-2-payload" class="sidebar-link">2.2 Payload</a></li><li class="sidebar-sub-header"><a href="/dotnet/auth/jwt.html#_2-3-signature" class="sidebar-link">2.3 Signature</a></li></ul></li><li class="sidebar-sub-header"><a href="/dotnet/auth/jwt.html#_3-jwt-net" class="sidebar-link">3. JWT.NET</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dotnet/auth/jwt.html#_3-1-创建和验证jwt" class="sidebar-link">3.1 创建和验证JWT</a></li><li class="sidebar-sub-header"><a href="/dotnet/auth/jwt.html#_3-2-jwt-认证方案" class="sidebar-link">3.2 JWT 认证方案</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>IdentityServer</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据访问</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>WebAPI</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>跨域资源共享</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>本地化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>健康检查</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其它主题</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="授权"><a href="#授权" class="header-anchor">#</a> 授权</h1> <p>认证旨在确定用户的真实身份，而授权则是通过权限控制使用户只能做其允许做的事。授权的本质就是通过设置一个策略来决定究竟具有何种特性的用户会被授权访问某个资源或者执行某个操作。我们可以采用任何授权策略，如可以根据用户拥有的角色进行授权，也可以根据用户的等级和所在部门进行授权，有的授权甚至可以根据用户的年龄、性别和所在国家来进行。认证后的用户体现为一个<code>ClaimsPrincipal</code> 对象，它携带的声明不仅仅用于描述用户的身份，还携带了上述这些构建授权策略的元素，所以授权实际上就是检查认证用户携带的声明是否与授权策略一致的过程。</p> <p>ASP.NET Core应用的授权是由通过<code>IAuthorizationService</code>接口表示的服务提供的。<code>IAuthorizationService</code> 服务提供了分别针对 <code>IAuthorizationRequirement</code> 和<code>AuthorizationPolicy</code>的授权方案</p> <h2 id="_1-基于-要求-的授权"><a href="#_1-基于-要求-的授权" class="header-anchor">#</a> 1. 基于“要求”的授权</h2> <h3 id="_1-1-iauthorizationrequirement"><a href="#_1-1-iauthorizationrequirement" class="header-anchor">#</a> 1.1 IAuthorizationRequirement</h3> <p><code>IAuthorizationRequirement</code> 接口表示授权访问目标资源或者操作在某个方面需要满足的要求（<code>Requirement</code>）。由于“授权要求”具有不同的表现形式，所以<code>IAuthorizationRequirement</code> 仅仅是一个不具有任何成员的“标记接口”。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IAuthorizationRequirement</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IAuthorizationHandler</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Task</span> <span class="token function">HandleAsync</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationHandlerContext</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>IAuthorizationRequirement</code> 接口体现了授权用户需要满足怎样的要求，也就是体现了如何检验某个用户是否满足对应的要求，所以大部分<code>IAuthorizationRequirement</code> 接口的实现类型也实现了 <code>IAuthorizationHandler</code> 接口，后者提供的<code>HandleAsync</code>方法实现了对应的授权检验。我们将<code>IAuthorizationHandler</code>对象称为授权处理器.</p> <p>授权处理器的<code>HandleAsync</code>方法具有一个类型为<code>AuthorizationHandlerContext</code> 的参数，代表授权检验的执行上下文。可以从这个上下文对象中得到待检验的用户（<code>User</code>）、授权的目标资源（<code>Resource</code>），以及应用到授权目标上的所有<code>IAuthorizationRequirement</code>对象，上述 3 个属性体现了授权检验的输入。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationHandlerContext</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">ClaimsPrincipal</span> User <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">object</span><span class="token punctuation">?</span></span> Resource <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>IAuthorizationRequirement<span class="token punctuation">&gt;</span></span> Requirements <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> HasFailed <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> HasSucceeded <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>IAuthorizationRequirement<span class="token punctuation">&gt;</span></span> PendingRequirements <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>授权成功和失败的标志通过 <code>HasSucceeded</code>属性与 <code>HasFailed</code>属性来表示，<code>PendingRequirements</code>属性则返回尚未经过检验的<code>IAuthorizationRequirement</code>对象。上述 3 个属性体现了授权检验的输出。对于一个刚刚被初始化的<code>AuthorizationHandlerContext</code>对象来说，<code>Requirements</code>和 <code>PendingRequirements</code>具有相同的元素。</p> <p>在针对某个 <code>IAuthorizationRequirement</code>对象实施授权检验的时候，如果不满足授权要求，我们可以直接调用 <code>AuthorizationHandlerContext</code>上下文的 <code>Fail</code>方法，该方法会将 <code>HasFailed</code>属性设置为<code>True</code>。反之，如果满足授权规则，我们可以将<code>IAuthorizationRequirement</code>对象作为参数调用<code>Succeed</code> 方法，该对象会从<code>PendingRequirements</code> 属性表示的列表中移除。只有在尚未调用 <code>Fail</code>方法并且其<code>PendingRequirements</code>属性集合为空的情况下，<code>AuthorizationHandlerContext</code>上下文的<code>HasSucceeded</code> 属性才会返回 <code>True</code>。换句话说，授权成功的前提是必须满足所有 <code>IAuthorizationRequirement</code>对象的授权要求。</p> <p>大部分授权处理器只关注某种单一的授权要求，这样的<code>IAuthorizationHandler</code>实现类型一般会派生于<code>AuthorizationHandler＜TRequirement＞</code>的抽象类，泛型参数<code>TRequirement</code>表示对应的<code>IAuthorizationRequirement</code>实现类型。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationHandler<span class="token punctuation">&lt;</span>TRequirement<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAuthorizationHandler</span></span> <span class="token keyword">where</span> <span class="token class-name">TRequirement</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAuthorizationRequirement</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">HandleAsync</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationHandlerContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> req <span class="token keyword">in</span> context<span class="token punctuation">.</span>Requirements<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">OfType</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRequirement<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> <span class="token function">HandleRequirementAsync</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token return-type class-name">Task</span> <span class="token function">HandleRequirementAsync</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationHandlerContext</span> context<span class="token punctuation">,</span> <span class="token class-name">TRequirement</span> requirement<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>AuthorizationHandler＜TRequirement＞</code>是从授权要求的角度对职责进行单一化的，那么抽象类<code>AuthorizationHandler＜TRequirement，TResource＞</code>则在此基础上将职责进一步细化到授权目标资源上。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationHandler<span class="token punctuation">&lt;</span>TRequirement<span class="token punctuation">,</span> TResource<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAuthorizationHandler</span></span> <span class="token keyword">where</span> <span class="token class-name">TRequirement</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAuthorizationRequirement</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">HandleAsync</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationHandlerContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Resource <span class="token keyword">is</span> <span class="token class-name">TResource</span><span class="token punctuation">)</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> req <span class="token keyword">in</span> context<span class="token punctuation">.</span>Requirements<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">OfType</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRequirement<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">await</span> <span class="token function">HandleRequirementAsync</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> req<span class="token punctuation">,</span> <span class="token punctuation">(</span>TResource<span class="token punctuation">)</span>context<span class="token punctuation">.</span>Resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token return-type class-name">Task</span> <span class="token function">HandleRequirementAsync</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationHandlerContext</span> context<span class="token punctuation">,</span> <span class="token class-name">TRequirement</span> requirement<span class="token punctuation">,</span> <span class="token class-name">TResource</span> resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_1-2-预定义iauthorizationrequirement"><a href="#_1-2-预定义iauthorizationrequirement" class="header-anchor">#</a> 1.2 预定义IAuthorizationRequirement</h3> <p>Asp.Net Core中预定义了<code>IAuthorizationRequirement</code>的常用实现类型，多数也实现了授权处理器接口 <code>IAuthorizationHandler</code>。</p> <h4 id="_1-2-1-denyanonymousauthorizationrequirement"><a href="#_1-2-1-denyanonymousauthorizationrequirement" class="header-anchor">#</a> 1.2.1 DenyAnonymousAuthorizationRequirement</h4> <p><code>DenyAnonymousAuthorizationRequirement</code> 体现的授权要求非常简单，那就是拒绝未被验证的匿名用户访问目标资源。它通过表示用户的<code>ClaimsPrincipal</code>对象是否具有一个经过认证的身份来确定当前请求是否来源于匿名用户。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DenyAnonymousAuthorizationRequirement</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AuthorizationHandler<span class="token punctuation">&lt;</span>DenyAnonymousAuthorizationRequirement<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IAuthorizationRequirement</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">HandleRequirementAsync</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationHandlerContext</span> context<span class="token punctuation">,</span> <span class="token class-name">DenyAnonymousAuthorizationRequirement</span> requirement<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> context<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> userIsAnonymous <span class="token operator">=</span>
            user<span class="token punctuation">?.</span>Identity <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
            <span class="token operator">!</span>user<span class="token punctuation">.</span>Identities<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>i <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span>IsAuthenticated<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userIsAnonymous<span class="token punctuation">)</span>
            context<span class="token punctuation">.</span><span class="token function">Succeed</span><span class="token punctuation">(</span>requirement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_1-2-2-claimsauthorizationrequirement"><a href="#_1-2-2-claimsauthorizationrequirement" class="header-anchor">#</a> 1.2.2 ClaimsAuthorizationRequirement</h4> <p>由于用户的权限大都以声明的形式保存在表示认证用户的 <code>ClaimsPrincipal</code> 对象上，所以授权检验实际上就是确定 <code>ClaimsPrincipal</code> 对象是否携带所需的授权声明，这样的授权检验是通过<code>ClaimsAuthorizationRequirement</code> 对象来完成的。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClaimsAuthorizationRequirement</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AuthorizationHandler<span class="token punctuation">&lt;</span>ClaimsAuthorizationRequirement<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IAuthorizationRequirement</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">ClaimsAuthorizationRequirement</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> claimType<span class="token punctuation">,</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">?</span></span> allowedValues<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> ClaimType <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">?</span></span> AllowedValues <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">HandleRequirementAsync</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationHandlerContext</span> context<span class="token punctuation">,</span> <span class="token class-name">ClaimsAuthorizationRequirement</span> requirement<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>User <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> found <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>requirement<span class="token punctuation">.</span>AllowedValues <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>requirement<span class="token punctuation">.</span>AllowedValues<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                found <span class="token operator">=</span> context<span class="token punctuation">.</span>User<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> requirement<span class="token punctuation">.</span>ClaimType<span class="token punctuation">,</span> StringComparison<span class="token punctuation">.</span>OrdinalIgnoreCase<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                found <span class="token operator">=</span> context<span class="token punctuation">.</span>User<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> requirement<span class="token punctuation">.</span>ClaimType<span class="token punctuation">,</span> StringComparison<span class="token punctuation">.</span>OrdinalIgnoreCase<span class="token punctuation">)</span>
                                                    <span class="token operator">&amp;&amp;</span> requirement<span class="token punctuation">.</span>AllowedValues<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> StringComparer<span class="token punctuation">.</span>Ordinal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>found<span class="token punctuation">)</span>
                context<span class="token punctuation">.</span><span class="token function">Succeed</span><span class="token punctuation">(</span>requirement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>如果我们创建 <code>ClaimsAuthorizationRequirement</code> 对象时只指定了声明类型，而没有指定声明的候选值，那么在进行授权检验的时候只要求表示当前用户的<code>ClaimsPrincipal</code> 对象携带任意一个与指定类型一致的声明即可。反之，如果指定了声明的候选值，那么就需要进行声明值的比较。值得注意的是，<strong>针对声明类型的比较是不区分大小写的，但是针对声明值的比较则是区分大小写的</strong>。</p> <h4 id="_1-2-3-nameauthorizationrequirement"><a href="#_1-2-3-nameauthorizationrequirement" class="header-anchor">#</a> 1.2.3 NameAuthorizationRequirement</h4> <p><code>NameAuthorizationRequirement</code> 类型旨在实现针对用户名的授权，也就是说，目标资源的访问授权给某个指定的用户。<strong>用户名比较是区分大小写的</strong>。授权用户的用户名体现为<code>RequiredName</code>属性。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NameAuthorizationRequirement</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AuthorizationHandler<span class="token punctuation">&lt;</span>NameAuthorizationRequirement<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IAuthorizationRequirement</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">NameAuthorizationRequirement</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> requiredName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> RequiredName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">HandleRequirementAsync</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationHandlerContext</span> context<span class="token punctuation">,</span> <span class="token class-name">NameAuthorizationRequirement</span> requirement<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>User <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>User<span class="token punctuation">.</span>Identities<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>i <span class="token operator">=&gt;</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> requirement<span class="token punctuation">.</span>RequiredName<span class="token punctuation">,</span> StringComparison<span class="token punctuation">.</span>Ordinal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                context<span class="token punctuation">.</span><span class="token function">Succeed</span><span class="token punctuation">(</span>requirement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_1-2-4-rolesauthorizationrequirement"><a href="#_1-2-4-rolesauthorizationrequirement" class="header-anchor">#</a> 1.2.4 RolesAuthorizationRequirement</h4> <p>针对角色的授权是最常用的授权方式。在这种授权方式下，我们将目标资源与一组角色列表进行关联，如果用户拥有其中任意一个角色，则意味着该用户具有访问目标资源的权限。与目标资源关联的角色列表存储于 <code>AllowedRoles</code> 属性表示的集合中。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RolesAuthorizationRequirement</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AuthorizationHandler<span class="token punctuation">&lt;</span>RolesAuthorizationRequirement<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IAuthorizationRequirement</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">RolesAuthorizationRequirement</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> allowedRoles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> AllowedRoles <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">HandleRequirementAsync</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationHandlerContext</span> context<span class="token punctuation">,</span> <span class="token class-name">RolesAuthorizationRequirement</span> requirement<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>User <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">bool</span></span> found <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>requirement<span class="token punctuation">.</span>AllowedRoles <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>requirement<span class="token punctuation">.</span>AllowedRoles<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// Review: What do we want to do here?  No roles requested is auto success?</span>
            <span class="token keyword">else</span>
                found <span class="token operator">=</span> requirement<span class="token punctuation">.</span>AllowedRoles<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">IsInRole</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>found<span class="token punctuation">)</span>
                context<span class="token punctuation">.</span><span class="token function">Succeed</span><span class="token punctuation">(</span>requirement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="_1-2-5-assertionrequirement"><a href="#_1-2-5-assertionrequirement" class="header-anchor">#</a> 1.2.5 AssertionRequirement</h4> <p>一个 <code>IAuthorizationHandler</code>对象针对授权规则的检验实际上体现为针对 <code>AuthorizationHandlerContext</code> 上下文的断言（<code>Assert</code>），该断言可以通过一个类型为 <code>Func＜AuthorizationHandlerContext，Task＜bool＞＞</code>的委托来表示。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AssertionRequirement</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAuthorizationHandler</span><span class="token punctuation">,</span> <span class="token class-name">IAuthorizationRequirement</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Func<span class="token punctuation">&lt;</span>AuthorizationHandlerContext<span class="token punctuation">,</span> Task<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> Handler <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token function">AssertionRequirement</span><span class="token punctuation">(</span><span class="token class-name">Func<span class="token punctuation">&lt;</span>AuthorizationHandlerContext<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token function">AssertionRequirement</span><span class="token punctuation">(</span><span class="token class-name">Func<span class="token punctuation">&lt;</span>AuthorizationHandlerContext<span class="token punctuation">,</span> Task<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">HandleAsync</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationHandlerContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">Handler</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span>
            context<span class="token punctuation">.</span><span class="token function">Succeed</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_1-2-6-operationauthorizationrequirement"><a href="#_1-2-6-operationauthorizationrequirement" class="header-anchor">#</a> 1.2.6 OperationAuthorizationRequirement</h4> <p>授权旨在限制非法用户针对某个资源的访问或者对某项操作的执行，而 <code>OperationAuthorizationRequirement</code>对象的目的在于将授权的目标对象映射到一个预定义的操作上，所以它只包含如下这个表示操作名称的<code>Name</code>属性。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OperationAuthorizationRequirement</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAuthorizationRequirement</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_1-2-7-passthroughauthorizationhandler"><a href="#_1-2-7-passthroughauthorizationhandler" class="header-anchor">#</a> 1.2.7 PassThroughAuthorizationHandler</h4> <p><code>PassThroughAuthorizationHandler</code> 是一个特殊的授权处理器类型，<code>AuthorizationHandlerContext</code>上下文中所有的 <code>IAuthorizationHandler</code> 都是通过该对象驱动执行的。它会从 <code>AuthorizationHandlerContext</code>的 <code>Requirements</code> 属性中提取所有 <code>IAuthorizationHandler</code> 对象，并逐个调用它们的<code>HandleAsync</code>方法来实施授权检验。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PassThroughAuthorizationHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAuthorizationHandler</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">HandleAsync</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationHandlerContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> handler <span class="token keyword">in</span> context<span class="token punctuation">.</span>Requirements<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">OfType</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IAuthorizationHandler<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> handler<span class="token punctuation">.</span><span class="token function">HandleAsync</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_1-3-授权服务"><a href="#_1-3-授权服务" class="header-anchor">#</a> 1.3 授权服务</h3> <h4 id="_1-3-1-iauthorizationservice"><a href="#_1-3-1-iauthorizationservice" class="header-anchor">#</a> 1.3.1 IAuthorizationService</h4> <p>应用程序最终针对授权的检验是通过 <code>IAuthorizationService</code> 服务来完成的。<code>IAuthorizationService</code>接口定义了如下所示的<code>AuthorizeAsync</code>方法，该方法会根据提供的<code>IAuthorizationRequirement</code>对象列表实施授权检验，该方法用一个<code>ClaimsPrincipal</code> 类型的参数（<code>user</code>）表示待检验的用户，而参数<code>resource</code>则表示授权的目标资源。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IAuthorizationService</span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>AuthorizationResult<span class="token punctuation">&gt;</span></span> <span class="token function">AuthorizeAsync</span><span class="token punctuation">(</span><span class="token class-name">ClaimsPrincipal</span> user<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">?</span></span> resource<span class="token punctuation">,</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>IAuthorizationRequirement<span class="token punctuation">&gt;</span></span> requirements<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>授权检验的结果可以用如下所示的 AuthorizationResult 类型来表示。如果授权成功，它的Succeeded 属性会返回 True；否则，授权失败的信息会保存在 Failure属性返回的AuthorizationFailure 对象中。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationResult</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token function">AuthorizationResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> Succeeded <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">AuthorizationFailure<span class="token punctuation">?</span></span> Failure <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">AuthorizationResult</span> <span class="token function">Success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">AuthorizationResult</span> <span class="token function">Failed</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationFailure</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">AuthorizationResult</span> <span class="token function">Failed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_1-3-2-defaultauthorizationservice"><a href="#_1-3-2-defaultauthorizationservice" class="header-anchor">#</a> 1.3.2 DefaultAuthorizationService</h4> <p><code>DefaultAuthorizationService</code> 类型是对 <code>IAuthorizationService</code> 接口的默认实现</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultAuthorizationService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAuthorizationService</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>AuthorizationResult<span class="token punctuation">&gt;</span></span> <span class="token function">AuthorizeAsync</span><span class="token punctuation">(</span><span class="token class-name">ClaimsPrincipal</span> user<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">?</span></span> resource<span class="token punctuation">,</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>IAuthorizationRequirement<span class="token punctuation">&gt;</span></span> requirements<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requirements <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>requirements<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> authContext <span class="token operator">=</span> _contextFactory<span class="token punctuation">.</span><span class="token function">CreateContext</span><span class="token punctuation">(</span>requirements<span class="token punctuation">,</span> user<span class="token punctuation">,</span> resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> handlers <span class="token operator">=</span> <span class="token keyword">await</span> _handlers<span class="token punctuation">.</span><span class="token function">GetHandlersAsync</span><span class="token punctuation">(</span>authContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> handler <span class="token keyword">in</span> handlers<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">await</span> handler<span class="token punctuation">.</span><span class="token function">HandleAsync</span><span class="token punctuation">(</span>authContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_options<span class="token punctuation">.</span>InvokeHandlersAfterFailure <span class="token operator">&amp;&amp;</span> authContext<span class="token punctuation">.</span>HasFailed<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> _evaluator<span class="token punctuation">.</span><span class="token function">Evaluate</span><span class="token punctuation">(</span>authContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>Succeeded<span class="token punctuation">)</span>
            _logger<span class="token punctuation">.</span><span class="token function">UserAuthorizationSucceeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            _logger<span class="token punctuation">.</span><span class="token function">UserAuthorizationFailed</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>Failure<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
        <span class="token comment">//... </span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>在实现的<code>AuthorizeAsync</code>方法中，<code>IAuthorizationHandlerContextFactory</code>工厂率先被用来创建代表授权上下文的<code>AuthorizationHandlerContext</code>对象。然后<code>IAuthorizationHandlerProvider</code>服务会从该上下文中提取出所有代表授权处理器的<code>IAuthorizationHandler</code> 对象。在将<code>AuthorizationHandlerContext</code> 上下文作为参数依次调用这组 <code>IAuthorizationHandler</code> 对象的<code>HandleAsync</code> 方法的过程中，如果当前授权结果为失败状态，并且 <code>AuthorizationOptions</code> 对象的<code>InvokeHandlersAfterFailure</code>属性返回<code>False</code>，那么整个授权检验过程将立即中止。<code>AuthorizeAsync</code>方法最终返回的是<code>IAuthorizationEvaluator</code>对象针对授权上下文评估的结果。</p> <h4 id="_1-3-3-服务注册"><a href="#_1-3-3-服务注册" class="header-anchor">#</a> 1.3.3 服务注册</h4> <p><code>DefaultAuthorizationService</code>及其依赖的服务是通过 <code>IServiceCollection</code>接口的<code>AddAuthorization</code>扩展方法注册的。注册这些服务采用的生命周期模式都是<code>Transient</code>。对于注册的这些服务来说，除了包含注入<code>DefaultAuthorizationService</code>构造函数的服务，还有一个针对<code>IAuthorizationHandler</code> 的服务注册，具体的实现类型为<code>PassThroughAuthorization</code> <code>Handler</code>。所以，在<code>DefaultAuthorizationHandlerProvider</code>的构造函数中注入的授权处理器集合其实只包含<code>PassThroughAuthorizationHandler</code>对象，该对象会从授权上下文中获取真正的<code>IAuthorizationHandler</code>对象来做最终的授权检验。</p> <h2 id="_2-基于-策略-的授权"><a href="#_2-基于-策略-的授权" class="header-anchor">#</a> 2. 基于“策略”的授权</h2> <p>如果在实施授权检验时总是针对授权的目标资源创建相应的<code>IAuthorizationRequirement</code>对象，这将是一项非常烦琐的工作，我们更加希望采用的编程模式如下：预先创建一组可复用的授权规则，在授权检验时提取对应的授权规则来确定用户是否具有访问目标资源的权限。</p> <h3 id="_2-1-构建授权策略"><a href="#_2-1-构建授权策略" class="header-anchor">#</a> 2.1 构建授权策略</h3> <p>授权策略在授权模型中体现为一个 <code>AuthorizationPolicy</code>对象，该对象采用 <code>Builder</code>模式利用对应的<code>AuthorizationPolicyBuilder</code>进行构建。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationPolicy</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">AuthorizationPolicy</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>IAuthorizationRequirement<span class="token punctuation">&gt;</span></span> requirements<span class="token punctuation">,</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> authenticationSchemes<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">IReadOnlyList<span class="token punctuation">&lt;</span>IAuthorizationRequirement<span class="token punctuation">&gt;</span></span> Requirements <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IReadOnlyList<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> AuthenticationSchemes <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>授权策略与采用的认证方式有关，所以<code>AuthorizationPolicy</code>类型利用其<code>AuthenticationSchemes</code>属性存储采用的认证方案名称。授权模型总是利用<code>IAuthorizationRequirement</code> 对象来表达“授权要求”，授权策略利用它们做出最终的决策。<code>AuthorizationPolicy</code>类型的 <code>Requirements</code>属性存储了一组<code>IAuthorizationRequirement</code>对象。</p> <p>除了调用构造函数来创建 <code>AuthorizationPolicy</code> 对象，我们还可以利用一个<code>AuthorizationPolicyBuilder</code> 对象以 <code>Builder</code> 模式来创建 <code>AuthorizationPolicy</code> 对象。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationPolicyBuilder</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">AuthorizationPolicyBuilder</span><span class="token punctuation">(</span><span class="token keyword">params</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> authenticationSchemes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token function">AuthorizationPolicyBuilder</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationPolicy</span> policy<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">IList<span class="token punctuation">&lt;</span>IAuthorizationRequirement<span class="token punctuation">&gt;</span></span> Requirements <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IList<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> AuthenticationSchemes <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">AuthorizationPolicyBuilder</span> <span class="token function">AddAuthenticationSchemes</span><span class="token punctuation">(</span><span class="token keyword">params</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> schemes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">AuthorizationPolicyBuilder</span> <span class="token function">AddRequirements</span><span class="token punctuation">(</span><span class="token keyword">params</span> <span class="token class-name">IAuthorizationRequirement<span class="token punctuation">[</span><span class="token punctuation">]</span></span> requirements<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">AuthorizationPolicyBuilder</span> <span class="token function">RequireClaim</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> claimType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">AuthorizationPolicyBuilder</span> <span class="token function">RequireClaim</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> claimType<span class="token punctuation">,</span> <span class="token keyword">params</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> allowedValues<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">AuthorizationPolicyBuilder</span> <span class="token function">RequireClaim</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> claimType<span class="token punctuation">,</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> allowedValues<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">AuthorizationPolicyBuilder</span> <span class="token function">RequireRole</span><span class="token punctuation">(</span><span class="token keyword">params</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> roles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">AuthorizationPolicyBuilder</span> <span class="token function">RequireRole</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">AuthorizationPolicyBuilder</span> <span class="token function">RequireUserName</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> userName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">AuthorizationPolicyBuilder</span> <span class="token function">RequireAuthenticatedUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">AuthorizationPolicyBuilder</span> <span class="token function">RequireAssertion</span><span class="token punctuation">(</span><span class="token class-name">Func<span class="token punctuation">&lt;</span>AuthorizationHandlerContext<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">AuthorizationPolicyBuilder</span> <span class="token function">RequireAssertion</span><span class="token punctuation">(</span><span class="token class-name">Func<span class="token punctuation">&lt;</span>AuthorizationHandlerContext<span class="token punctuation">,</span> Task<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">AuthorizationPolicyBuilder</span> <span class="token function">Combine</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationPolicy</span> policy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>一个 <code>AuthorizationPolicy</code> 对象的有效内容荷载就是一组认证方案列表和一组<code>IAuthorization</code> <code>Requirement</code>对象列表。可以使用以上方法将预定义的 <code>IAuthorizationRequirement</code> 实现类型添加到 <code>Requirements</code> 集合中。</p> <p>有时我们需要将两个 <code>AuthorizationPolicy</code>对象提供的这两组数据进行合并，所以 <code>AuthorizationPolicyBuilder</code> 类型提供了如下所示的 <code>Combine</code> 方法。除了这个实例方法，<code>AuthorizationPolicy</code>类型还提供了两个静态的<code>Combine</code>方法，用来实现针对多个<code>AuthorizationPolicy</code>对象的合并。</p> <h3 id="_2-2-注册授权策略"><a href="#_2-2-注册授权策略" class="header-anchor">#</a> 2.2 注册授权策略</h3> <p>针对授权策略的注册需要使用配置选项 <code>AuthorizationOptions</code>。<code>AuthorizationOptions</code> 对象通过一个字典对象维护一组<code>AuthorizationPolicy</code>对象和对应名称的映射关系，我们可以调用两个 <code>AddPolicy</code>方法来向这个字典中添加新的映射关系，也可以调用 <code>GetPolicy</code>方法根据指定策略名称得到对应的<code>AuthorizationPolicy</code>对象。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationOptions</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token return-type class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> AuthorizationPolicy<span class="token punctuation">&gt;</span></span> PolicyMap <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">AuthorizationPolicy</span> DefaultPolicy <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name">AuthorizationPolicy</span> policy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name">Action<span class="token punctuation">&lt;</span>AuthorizationPolicyBuilder<span class="token punctuation">&gt;</span></span> configurePolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">AuthorizationPolicy<span class="token punctuation">?</span></span> <span class="token function">GetPolicy</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>如果调用<code>GetPolicy</code>方法时指定的策略名称不存在，该方法就会返回<code>Null</code>。在这种情况下，可以选择使用默认的授权策略，针对默认授权策略的设置可以通过<code>AuthorizationOptions</code> 对象的<code>DefaultPolicy</code>属性来实现。</p> <h3 id="_2-3-授权检验"><a href="#_2-3-授权检验" class="header-anchor">#</a> 2.3 授权检验</h3> <p>基于策略的授权在 <code>DefaultAuthorizationService</code> 类型中是通过如下所示的方式实现的。在实现的 <code>AuthorizeAsync</code> 方法中，<code>DefaultAuthorizationService</code> 对象会利用构造函数中注入的<code>IAuthorizationPolicyProvider</code> 对象根据指定的策略名称得到对应的授权策略，并从表示授权策略的 <code>AuthorizationPolicy</code> 对象中得到所有的<code>IAuthorizationRequirement</code> 对象。<code>DefaultAuthorizationService</code> 对象将这些<code>IAuthorizationRequirement</code> 对象作为参数调用 <code>AuthorizeAsync</code> 方法重载来完成授权检验。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultAuthorizationService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAuthorizationService</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>AuthorizationResult<span class="token punctuation">&gt;</span></span> <span class="token function">AuthorizeAsync</span><span class="token punctuation">(</span><span class="token class-name">ClaimsPrincipal</span> user<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">?</span></span> resource<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> policyName<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>policyName <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>policyName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> policy <span class="token operator">=</span> <span class="token keyword">await</span> _policyProvider<span class="token punctuation">.</span><span class="token function">GetPolicyAsync</span><span class="token punctuation">(</span>policyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>policy <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InvalidOperationException</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;No policy found: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">policyName</span><span class="token punctuation">}</span></span><span class="token string">.&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">AuthorizeAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> policy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>应用程序最终利用 <code>IAuthorizationService</code>服务针对目标操作或者资源实施授权检验，<code>DefaultAuthorizationService</code> 类型是对该服务接口的默认实现。<code>IAuthorizationService</code> 服务具体提供了两种授权检验模式，一种是针对提供的<code>IAuthorizationRequirement</code>对象列表实施授权，另一种则是针对注册的某个通过<code>AuthorizationPolicy</code> 对象表示的授权策略，后者由注册的<code>IAuthorizationPolicyProvider</code>服务提供。</p> <h2 id="_3-授权案例"><a href="#_3-授权案例" class="header-anchor">#</a> 3. 授权案例</h2> <p>通过前面章节的讲解我们了解到，ASP.NET Core 应用并没有对如何定义授权策略做硬性规定，所以我们完全根据用户具有的任意特性（如性别、年龄、学历、所在地区、宗教信仰、政治面貌等）来判断其是否具有获取目标资源或者执行目标操作的权限，但是针对角色的授权策略依然是最常用的。角色（或者用户组）实际上就是对一组权限集的描述，将一个用户添加到某个角色之中就是为了将对应的权限赋予该用户。</p> <p>接下来我们就简单演示基于角色的授权案例，案例内容基于上一节<a href="/dotnet/auth/authentication.html#_3-认证案例">认证</a>做简单修改，我们约定主页必须具有<code>Administrator</code>角色才能访问。</p> <h3 id="_3-1-基于-要求-的角色授权"><a href="#_3-1-基于-要求-的角色授权" class="header-anchor">#</a> 3.1 基于“要求”的角色授权</h3> <div class="language-csharp line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Host<span class="token punctuation">.</span><span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ConfigureWebHostDefaults</span><span class="token punctuation">(</span>builder <span class="token operator">=&gt;</span> builder
            <span class="token punctuation">.</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span>services <span class="token operator">=&gt;</span> services
                <span class="token punctuation">.</span><span class="token function">AddRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>CookieAuthenticationDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AddCookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Configure</span><span class="token punctuation">(</span>app <span class="token operator">=&gt;</span> app
                <span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=&gt;</span>
                <span class="token punctuation">{</span>
                    endpoints<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> RenderHomePageAsync<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    endpoints<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span><span class="token string">&quot;Account/Login&quot;</span><span class="token punctuation">,</span> SignInAsync<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    endpoints<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span><span class="token string">&quot;Account/Logout&quot;</span><span class="token punctuation">,</span> SignOutAsync<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    endpoints<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span><span class="token string">&quot;Account/AccessDenied&quot;</span><span class="token punctuation">,</span> DenyAccessAsync<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RenderHomePageAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> authorizationService <span class="token operator">=</span> context<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IAuthorizationService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> authorizationService<span class="token punctuation">.</span><span class="token function">AuthorizeAsync</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IAuthorizationRequirement<span class="token punctuation">[</span><span class="token punctuation">]</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DenyAnonymousAuthorizationRequirement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RolesAuthorizationRequirement</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">&quot;Administrator&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>Succeeded<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>Failure<span class="token punctuation">?.</span>FailedRequirements<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r <span class="token keyword">is</span> <span class="token class-name">DenyAnonymousAuthorizationRequirement</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">ChallengeAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">ForbidAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> <span class="token string">&quot;text/html&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>
        <span class="token interpolation-string"><span class="token string">@$&quot;
            &lt;!DOCTYPE html&gt;
            &lt;html lang='en'&gt;
            &lt;head&gt;&lt;title&gt;Index&lt;/title&gt;
            &lt;/head&gt;
            &lt;body&gt;
                &lt;h3&gt;Welcome </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">context<span class="token punctuation">.</span>User<span class="token punctuation">.</span>Identity<span class="token punctuation">.</span>Name</span><span class="token punctuation">}</span></span><span class="token string">, you're authorized&lt;/h3&gt;
                &lt;a href='/Account/Logout'&gt;Sign Out&lt;/a&gt;    
            &lt;/body&gt;
            &lt;/html&gt;&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">SignInAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>HttpMethods<span class="token punctuation">.</span>Get<span class="token punctuation">,</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Method<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token function">RenderSignInPageAsync</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name"><span class="token keyword">string</span></span> username<span class="token punctuation">,</span> password<span class="token punctuation">;</span>
    username <span class="token operator">=</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Form<span class="token punctuation">[</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    password <span class="token operator">=</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Form<span class="token punctuation">[</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> Users<span class="token punctuation">.</span><span class="token function">SingleOrDefault</span><span class="token punctuation">(</span>u <span class="token operator">=&gt;</span>
        <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>Username<span class="token punctuation">,</span> username<span class="token punctuation">,</span> StringComparison<span class="token punctuation">.</span>OrdinalIgnoreCase<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>user<span class="token punctuation">?.</span>Password<span class="token punctuation">,</span> password<span class="token punctuation">,</span> StringComparison<span class="token punctuation">.</span>OrdinalIgnoreCase<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token function">RenderSignInPageAsync</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> <span class="token string">&quot;invalid username or password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name"><span class="token keyword">var</span></span> identity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GenericIdentity</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> CookieAuthenticationDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> role <span class="token keyword">in</span> user<span class="token punctuation">.</span>Roles<span class="token punctuation">)</span>
        identity<span class="token punctuation">.</span><span class="token function">AddClaim</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Role<span class="token punctuation">,</span> role<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> principal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GenericPrincipal</span><span class="token punctuation">(</span>identity<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">SignInAsync</span><span class="token punctuation">(</span>principal<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">SignOutAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">SignOutAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">ChallengeAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AuthenticationProperties</span> <span class="token punctuation">{</span>RedirectUri <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">DenyAccessAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> <span class="token string">&quot;text/html&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>
        <span class="token interpolation-string"><span class="token string">@$&quot;
            &lt;!DOCTYPE html&gt;
            &lt;html lang='en'&gt;
            &lt;head&gt;&lt;title&gt;Index&lt;/title&gt;
            &lt;/head&gt;
            &lt;body&gt;
                &lt;h3&gt;Sorry </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">context<span class="token punctuation">.</span>User<span class="token punctuation">.</span>Identity<span class="token punctuation">.</span>Name</span><span class="token punctuation">}</span></span><span class="token string">, you're not authorized&lt;/h3&gt;
                &lt;a href='/Account/Logout'&gt;Sign Out&lt;/a&gt;    
            &lt;/body&gt;
            &lt;/html&gt;&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RenderSignInPageAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> username <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token class-name"><span class="token keyword">string</span></span> password <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token class-name"><span class="token keyword">string</span></span> message <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> <span class="token string">&quot;text/html&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>
        <span class="token interpolation-string"><span class="token string">@$&quot;
            &lt;!DOCTYPE html&gt;
            &lt;html lang='en'&gt;
            &lt;head&gt;&lt;title&gt;Sign In&lt;/title&gt;
            &lt;/head&gt;
            &lt;body&gt;
                &lt;form method='post'&gt;
                    &lt;input type='text' name='username' placeholder='Username' value='</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">username</span><span class="token punctuation">}</span></span><span class="token string">' /&gt;
                    &lt;input type='password' name='password' placeholder='Password' value='</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">password</span><span class="token punctuation">}</span></span><span class="token string">' /&gt;
                    &lt;input type='submit' value='Sign In' /&gt;
                &lt;/form&gt;
                &lt;p style='color:red'&gt;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">message</span><span class="token punctuation">}</span></span><span class="token string">&lt;/p&gt;
            &lt;/body&gt;
            &lt;/html&gt;&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> Users <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;Colin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Role</span><span class="token punctuation">(</span><span class="token string">&quot;Administrator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;Robin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Role</span><span class="token punctuation">(</span><span class="token string">&quot;Users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Username <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Password <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>Role<span class="token punctuation">&gt;</span></span> Roles <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">User</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> username<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">,</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>Role<span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Username <span class="token operator">=</span> username<span class="token punctuation">;</span>
        Password <span class="token operator">=</span> password<span class="token punctuation">;</span>
        Roles <span class="token operator">=</span> roles<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Role</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token function">Role</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Name <span class="token operator">=</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br></div></div><h3 id="_3-2-基于-策略-的角色授权"><a href="#_3-2-基于-策略-的角色授权" class="header-anchor">#</a> 3.2 基于“策略”的角色授权</h3> <p>我们使用基于“策略”的授权重构以上代码，只需要在注册授权服务时定义授权策略，授权检查时使用策略即可。下面只列出关键代码。</p> <div class="language-csharp line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Host<span class="token punctuation">.</span><span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ConfigureWebHostDefaults</span><span class="token punctuation">(</span>builder <span class="token operator">=&gt;</span> builder
            <span class="token punctuation">.</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span>services <span class="token operator">=&gt;</span> services
                <span class="token punctuation">.</span><span class="token function">AddRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span> options
                    <span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">&quot;Admin&quot;</span><span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span>
                    <span class="token punctuation">{</span>
                        <span class="token comment">//policy.AddRequirements(new DenyAnonymousAuthorizationRequirement());</span>
                        <span class="token comment">//policy.AddRequirements(new RolesAuthorizationRequirement(new[] {&quot;Administrator&quot;}));</span>

                        policy<span class="token punctuation">.</span><span class="token function">RequireAuthenticatedUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        policy<span class="token punctuation">.</span><span class="token function">RequireRole</span><span class="token punctuation">(</span><span class="token string">&quot;Administrator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>CookieAuthenticationDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AddCookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Configure</span><span class="token punctuation">(</span>app <span class="token operator">=&gt;</span> app
                <span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=&gt;</span>
                <span class="token punctuation">{</span>
                    endpoints<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> RenderHomePageAsync<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    endpoints<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span><span class="token string">&quot;Account/Login&quot;</span><span class="token punctuation">,</span> SignInAsync<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    endpoints<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span><span class="token string">&quot;Account/Logout&quot;</span><span class="token punctuation">,</span> SignOutAsync<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    endpoints<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span><span class="token string">&quot;Account/AccessDenied&quot;</span><span class="token punctuation">,</span> DenyAccessAsync<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RenderHomePageAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> context<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> authorizationService <span class="token operator">=</span> context<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IAuthorizationService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> authorizationService<span class="token punctuation">.</span><span class="token function">AuthorizeAsync</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token string">&quot;Admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>Succeeded<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>Failure<span class="token punctuation">?.</span>FailedRequirements<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r <span class="token keyword">is</span> <span class="token class-name">DenyAnonymousAuthorizationRequirement</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">ChallengeAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">ForbidAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>
        <span class="token interpolation-string"><span class="token string">@$&quot;
            &lt;!DOCTYPE html&gt;
            &lt;html lang='en'&gt;
            &lt;head&gt;&lt;title&gt;Index&lt;/title&gt;
            &lt;/head&gt;
            &lt;body&gt;
                &lt;h3&gt;Welcome </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">context<span class="token punctuation">.</span>User<span class="token punctuation">.</span>Identity<span class="token punctuation">.</span>Name</span><span class="token punctuation">}</span></span><span class="token string">, you're authorized&lt;/h3&gt;
                &lt;a href='/Account/Logout'&gt;Sign Out&lt;/a&gt;    
            &lt;/body&gt;
            &lt;/html&gt;&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><h3 id="_3-3-授权中间件与mvc过滤器"><a href="#_3-3-授权中间件与mvc过滤器" class="header-anchor">#</a> 3.3 授权中间件与MVC过滤器</h3> <p>授权中间件<code>AuthorizationMiddleware</code>通常与MVC框架中<code>AuthorizeFilter</code>一起使用，通过查看<code>AuthorizationMiddleware</code>源码可以发现其中间件会执行过滤器中的授权检查规则。</p> <p>下面我们使用授权中间件(<code>AuthorizationMiddleware</code>)与 MVC授权过滤器(<code>AuthorizeFilter</code>)来重构以上案例。</p> <p>在<code>Startup</code>中注册认证和授权服务和授权策略与中间件，需要注意中间件注入的顺序。</p> <div class="language-csharp line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br></div><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Startup</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        services<span class="token punctuation">.</span><span class="token function">AddControllersWithViews</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        services<span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>CookieAuthenticationDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddCookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        services<span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span> options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            policy<span class="token punctuation">.</span><span class="token function">RequireAuthenticatedUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            policy<span class="token punctuation">.</span><span class="token function">RequireRole</span><span class="token punctuation">(</span><span class="token string">&quot;Administrator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">,</span> <span class="token class-name">IWebHostEnvironment</span> env<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            app<span class="token punctuation">.</span><span class="token function">UseDeveloperExceptionPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            app<span class="token punctuation">.</span><span class="token function">UseExceptionHandler</span><span class="token punctuation">(</span><span class="token string">&quot;/Home/Error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">UseHsts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            endpoints<span class="token punctuation">.</span><span class="token function">MapControllerRoute</span><span class="token punctuation">(</span>
                <span class="token named-parameter punctuation">name</span><span class="token punctuation">:</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span>
                <span class="token named-parameter punctuation">pattern</span><span class="token punctuation">:</span> <span class="token string">&quot;{controller=Home}/{action=Index}/{id?}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>在<code>HomeController</code>中使用 MVC授权过滤器对多个<code>Action</code>方法进行不同的授权检查。</p> <div class="language-csharp line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Controller</span></span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Roles <span class="token operator">=</span> <span class="token string">&quot;User&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">Privacy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ResponseCache</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Duration <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Location <span class="token operator">=</span> ResponseCacheLocation<span class="token punctuation">.</span>None<span class="token punctuation">,</span> NoStore <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ErrorViewModel</span>
        <span class="token punctuation">{</span>RequestId <span class="token operator">=</span> Activity<span class="token punctuation">.</span>Current<span class="token punctuation">?.</span>Id <span class="token operator">??</span> HttpContext<span class="token punctuation">.</span>TraceIdentifier<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>Authorize</code>过滤器不提供任何参数时只会进行匿名用户鉴权，也可以传入角色或策略名称进行角色或策略进行鉴权。以逗号分隔角色名来允行多个角色访问操作，其中只要满足其一就可以进行访问。如以下方法<code>Administrator</code>或<code>User</code>角色均可访问。</p> <div class="language-csharp line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br></div><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Roles <span class="token operator">=</span> <span class="token string">&quot;Administrator,User&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">Privacy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>下面的方法只有同时具有<code>Administrator</code>和<code>User</code>角色的用户才可访问</p> <div class="language-csharp line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Roles <span class="token operator">=</span> <span class="token string">&quot;Administrator&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Roles <span class="token operator">=</span> <span class="token string">&quot;User&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">Privacy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>因为使用了基于<code>Cookie</code>的认证策略，所以授权检查不通过时会自动重定向到<code>/Account/Login</code>，下面是<code>AccountController</code>中的认证实现。</p> <div class="language-csharp line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Controller</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> Users <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;Colin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;123123&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Role</span><span class="token punctuation">(</span><span class="token string">&quot;Administrator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Role</span><span class="token punctuation">(</span><span class="token string">&quot;User&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;Robin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;123123&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Role</span><span class="token punctuation">(</span><span class="token string">&quot;User&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">Login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">Login</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">Challenge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> usr <span class="token operator">=</span> Users<span class="token punctuation">.</span><span class="token function">SingleOrDefault</span><span class="token punctuation">(</span>u <span class="token operator">=&gt;</span>
            <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>Username<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Username<span class="token punctuation">,</span> StringComparison<span class="token punctuation">.</span>OrdinalIgnoreCase<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>usr<span class="token punctuation">?.</span>Password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Password<span class="token punctuation">,</span> StringComparison<span class="token punctuation">.</span>OrdinalIgnoreCase<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            ViewBag<span class="token punctuation">.</span>Message <span class="token operator">=</span> <span class="token string">&quot;invalid username or password&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">View</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name"><span class="token keyword">var</span></span> identity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GenericIdentity</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Username<span class="token punctuation">,</span> CookieAuthenticationDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> role <span class="token keyword">in</span> usr<span class="token punctuation">.</span>Roles<span class="token punctuation">)</span>
            identity<span class="token punctuation">.</span><span class="token function">AddClaim</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Role<span class="token punctuation">,</span> role<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> principal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GenericPrincipal</span><span class="token punctuation">(</span>identity<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">SignIn</span><span class="token punctuation">(</span>principal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">Logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token function">SignOut</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AuthenticationProperties</span> <span class="token punctuation">{</span>RedirectUri <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">AccessDenied</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>为方便使用，认证相关的<code>SignIn</code>/<code>SignOut</code>等几个核心操作都扩展在了<code>Controller</code>类中，使用方式如上。</p> <p>以上案例的模型类和相关视图不涉及认证授权逻辑，此处不再展示。完整案例代码参见<a href="https://github.com/colin-chang/AuthSamples/tree/main/ColinChang.MvcSample" target="_blank" rel="noopener noreferrer">Github<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/19/2021, 3:41:48 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/dotnet/auth/authentication.html" class="prev">
        认证
      </a></span> <span class="next"><a href="/dotnet/auth/jwt.html">
        JWT
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/dotnet/assets/js/app.4e9b76c2.js" defer></script><script src="/dotnet/assets/js/2.86915a18.js" defer></script><script src="/dotnet/assets/js/13.08e3036f.js" defer></script>
  </body>
</html>
